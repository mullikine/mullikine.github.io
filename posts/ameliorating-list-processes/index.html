<!doctype html>
<html lang="en-us">
  <head>
    <title>Ameliorating list-processes // Bodacious Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.71.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Shane Mulligan" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://mullikine.github.io/css/main.min.c93a97e54f16df99439e5c4acf79edb18fcb9e5384f1edc008a7a4639844b254.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ameliorating list-processes"/>
<meta name="twitter:description" content="What is list-processes? list-processes is an emacs-lisp function which displays daemons running as subprocesses under emacs.
The trouble with list-processes  It doesn&rsquo;t format the command string  Commands with multiline arguments are printed verbatim Arguments are not quoted    This means that commands may flow several lines (as many as it takes to print out the full command).
Also, 90% of the time you can&rsquo;t copy the command and paste in the terminal because individual parameters with spaces are split into separate arguments."/>

    <meta property="og:title" content="Ameliorating list-processes" />
<meta property="og:description" content="What is list-processes? list-processes is an emacs-lisp function which displays daemons running as subprocesses under emacs.
The trouble with list-processes  It doesn&rsquo;t format the command string  Commands with multiline arguments are printed verbatim Arguments are not quoted    This means that commands may flow several lines (as many as it takes to print out the full command).
Also, 90% of the time you can&rsquo;t copy the command and paste in the terminal because individual parameters with spaces are split into separate arguments." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mullikine.github.io/posts/ameliorating-list-processes/" />
<meta property="article:published_time" content="2019-09-18T00:00:00+12:00" />
<meta property="article:modified_time" content="2019-09-18T00:00:00+12:00" /><meta property="og:site_name" content="Bodacious Blog" />


  </head>
  <body>
    <header class="app-header">

<a href="https://mullikine.github.io"><img class="app-header-avatar" src="http://mullikine.github.io/fievel.png" alt="Shane Mulligan" /></a>
      <h1>Bodacious Blog</h1>
      
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://linkedin.com/in/shane-mulligan-811b942b/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
        
          <a target="_blank" href="https://gitlab.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-gitlab">
  <title>gitlab</title>
  <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
        <a href="https://mullikine.github.io/cv/">CV</a>
      </div>
<div class="highlights">
<a href="https://mullikine.github.io/posts/practical-macros-in-racket-and-how-to-work-with-them/">Practical macros in Racket</a>
<br />
<a href="https://mullikine.github.io/posts/github-search-with-bigquery/">Searching GitHub with BigQuery</a>

<br />
<a href="https://mullikine.github.io/posts/arbitrary-interpreters-for-babel/">Arbitrary interpreters for Babel</a>
<br />
<a href="https://mullikine.github.io/posts/review-of-the-illustrated-transformer/">The Illustrated Transformer</a>
<br />
<a href="https://mullikine.github.io/glossary.html">Glossary A-Z (70 topics)</a>
<br />
<a href="https://mullikine.github.io/codelingo-vs-linters/summary/">CodeLingo vs Linters</a>
<br />
<div class="taglist">

<a class="tag" href="https://mullikine.github.io/tags/biosemiotics/">biosemiotics</a>
<a class="tag" href="https://mullikine.github.io/tags/xenolinguistics/">xenolinguistics</a>
<a class="tag big" href="https://mullikine.github.io/tags/emacs/">emacs</a>
<a class="tag" href="https://mullikine.github.io/tags/gpt/">GPT (Generative Pre-Training)</a>
<a class="tag" href="https://mullikine.github.io/tags/elisp/">elisp</a>
<a class="tag" href="https://mullikine.github.io/tags/racket/">racket</a>
<a class="tag" href="https://mullikine.github.io/tags/haskell/">haskell</a>
<a class="tag" href="https://mullikine.github.io/tags/nlp/">NLP</a>
<a class="tag" href="https://mullikine.github.io/tags/docker/">docker</a>
<a class="tag" href="https://mullikine.github.io/tags/feature-engineering/">feature-engineering</a>
<a class="tag big" href="https://mullikine.github.io/tags/ir/">IR</a>
<a class="tag" href="https://mullikine.github.io/tags/games/">games</a>
<a class="tag" href="https://mullikine.github.io/tags/data/">data</a>
<a class="tag" href="https://mullikine.github.io/tags/info/">info theory</a>
<a class="tag" href="https://mullikine.github.io/tags/probability/">probability</a>
<a class="tag" href="https://mullikine.github.io/tags/problog/">problog</a>
<a class="tag big" href="https://mullikine.github.io/tags/shell/">shell</a>
<a class="tag" href="https://mullikine.github.io/tags/gcp/">GCP</a>
<a class="tag big" href="https://mullikine.github.io/tags/github/">GitHub</a>
<a class="tag" href="https://mullikine.github.io/tags/parsers/">parsers</a>
<a class="tag" href="https://mullikine.github.io/tags/rust/">rust</a>
<a class="tag" href="https://mullikine.github.io/tags/cpp/">c++</a>
<a class="tag" href="https://mullikine.github.io/tags/review/">review</a>
<a class="tag" href="https://mullikine.github.io/tags/kaggle/">kaggle</a>
<a class="tag" href="https://mullikine.github.io/tags/dl/">deep learning</a>
<a class="tag" href="https://mullikine.github.io/tags/dsl/">DSL</a>
<a class="tag" href="https://mullikine.github.io/tags/df/">dwarf fortress</a>
<a class="tag" href="https://mullikine.github.io/tags/spacy/">spacy</a>
<a class="tag" href="https://mullikine.github.io/tags/latex/">latex</a>
<a class="tag" href="https://mullikine.github.io/tags/nix/">Nix</a>
<a class="tag" href="https://mullikine.github.io/tags/diagrams/">diagrams</a>
<a class="tag" href="https://mullikine.github.io/tags/python/">python</a>
<a class="tag" href="https://mullikine.github.io/tags/golang/">golang</a>
<a class="tag" href="https://mullikine.github.io/tags/codelingo/">codelingo</a>
<a class="tag" href="https://mullikine.github.io/tags/perl/">perl</a>
<a class="tag" href="https://mullikine.github.io/tags/math/">math</a>
<a class="tag big" href="https://mullikine.github.io/tags/vim/">vim</a>
<a class="tag" href="https://mullikine.github.io/tags/telco/">telco</a>
<a class="tag" href="https://mullikine.github.io/tags/automation/">automation</a>
<a class="tag" href="https://mullikine.github.io/tags/terminals/">terminals</a>
<a class="tag" href="https://mullikine.github.io/tags/transformer/">transformer</a>
<a class="tag big" href="https://mullikine.github.io/tags/codegen/">code-gen</a>
<a class="tag" href="https://mullikine.github.io/tags/optimisation/">optimisation</a>
<a class="tag" href="https://mullikine.github.io/tags/release/">release</a>
<a class="tag" href="https://mullikine.github.io/tags/dotnet/">.NET</a>
<a class="tag" href="https://mullikine.github.io/tags/csharp/">csharp</a>
<a class="tag" href="https://mullikine.github.io/tags/tooling/">tooling</a>
<a class="tag" href="https://mullikine.github.io/tags/iac/">IaC</a>
<a class="tag big" href="https://mullikine.github.io/tags/facebook/">Facebook</a>
<a class="tag" href="https://mullikine.github.io/tags/wfh/">WFH</a>
<a class="tag big" href="https://mullikine.github.io/tags/rocketlab/">Rocket Lab</a>
<a class="tag" href="https://mullikine.github.io/tags/prayer/">prayer</a>
<a class="tag" href="https://mullikine.github.io/tags/babel/">babel</a>
</div>
</div>
<div class="highlights">
<a href="https://mullikine.github.io/posts/rat/">Automating rat</a>
<br />
<a href="https://mullikine.github.io/posts/dwarf-fortress-macros-with-emacs-and-tmux/">Automating Dwarf Fortress</a>
<br />
</div>


</div>
<div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Ameliorating list-processes</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Sep 18, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          2 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://mullikine.github.io/tags/emacs/">emacs</a><a class="tag" href="http://mullikine.github.io/tags/elisp/">elisp</a></div></div>
    </header>
    

<link rel="stylesheet" type="text/css" href="https://mullikine.github.io/css/magit.css"/>

<script src="https://mullikine.github.io/js/mathjax-config.js"></script>
 
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>


    <div class="post-content">
      <h3 id="what-is-list-processes">What is <code>list-processes</code>?</h3>
<p><code>list-processes</code> is an emacs-lisp function
which displays daemons running as subprocesses
under emacs.</p>
<h3 id="the-trouble-with-list-processes">The trouble with <code>list-processes</code></h3>
<ul>
<li>It doesn&rsquo;t format the command string
<ul>
<li>Commands with multiline arguments are printed verbatim</li>
<li>Arguments are not quoted</li>
</ul>
</li>
</ul>
<p>This means that commands may flow several
lines (as many as it takes to print out the
full command).</p>
<p>Also, 90% of the time you can&rsquo;t copy the
command and paste in the terminal because
individual parameters with spaces are split
into separate arguments.</p>
<h2 id="the-thing-that-tipped-me-over-the-edge">The thing that tipped me over the edge</h2>
<p><code>anaconda-mode</code> takes up the entire process list
with one big, paunchy command.</p>
<h3 id="the-fix">The fix</h3>
<h4 id="this-code-quotes-each-argument-and-replaces-actual-newlines-with-escape-codes">This code quotes each argument and replaces actual newlines with escape codes</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-emacs" data-lang="emacs">(let* ((fullcmd (<span style="color:#a6e22e">mapconcat</span> <span style="color:#e6db74">&#39;e/q</span> (<span style="color:#a6e22e">process-command</span> p) <span style="color:#e6db74">&#34; &#34;</span>))
                  (oneliner (replace-regexp-in-string <span style="color:#e6db74">&#34;\n&#34;</span> <span style="color:#e6db74">&#34;\\n&#34;</span> fullcmd <span style="color:#66d9ef">t</span> <span style="color:#66d9ef">t</span>))
                  <span style="color:#75715e">;; This works but instead of trimming i want to turn everything into one line</span>
                  <span style="color:#75715e">;; (fullcmdlen (length fullcmd))</span>
                  <span style="color:#75715e">;; (shortcmd (substring fullcmd 0 (min fullcmdlen (window-total-width))))</span>
                  )
             (<span style="color:#a6e22e">concat</span> <span style="color:#e6db74">&#34;{&#34;</span> oneliner <span style="color:#e6db74">&#34;}&#34;</span>) <span style="color:#75715e">; Surround with braces to allow selecting the command easily. Braces are also valid shell.</span>
             <span style="color:#75715e">;; shortcmd</span>
             )
</code></pre></div><h4 id="place-the-above-fix-into-the-list-processes-refresh-function">Place the above fix into the <code>list-processes--refresh</code> function</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-emacs" data-lang="emacs">(defun list-processes--refresh ()
  <span style="color:#e6db74">&#34;Recompute the list of processes for the Process List buffer.
</span><span style="color:#e6db74">Also, delete any process that is exited or signaled.&#34;</span>
  (setq tabulated-list-entries <span style="color:#66d9ef">nil</span>)
  (dolist (p (<span style="color:#a6e22e">process-list</span>))
    (cond ((<span style="color:#a6e22e">memq</span> (<span style="color:#a6e22e">process-status</span> p) <span style="color:#f92672">&#39;</span>(exit <span style="color:#a6e22e">signal</span> closed))
     (<span style="color:#a6e22e">delete-process</span> p))
    ((or (not process-menu-query-only)
         (<span style="color:#a6e22e">process-query-on-exit-flag</span> p))
     (let* ((buf (<span style="color:#a6e22e">process-buffer</span> p))
      (type (<span style="color:#a6e22e">process-type</span> p))
      (pid  (if (<span style="color:#a6e22e">process-id</span> p) (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;%d&#34;</span> (<span style="color:#a6e22e">process-id</span> p)) <span style="color:#e6db74">&#34;--&#34;</span>))
      (name (<span style="color:#a6e22e">process-name</span> p))
      (status (<span style="color:#a6e22e">symbol-name</span> (<span style="color:#a6e22e">process-status</span> p)))
      (buf-label (if (<span style="color:#a6e22e">buffer-live-p</span> buf)
         <span style="color:#f92672">`</span>(<span style="color:#f92672">,</span>(<span style="color:#a6e22e">buffer-name</span> buf)
           face link
           help-echo <span style="color:#f92672">,</span>(format-message
                 <span style="color:#e6db74">&#34;Visit buffer </span><span style="color:#e6db74">`%s&#39;</span><span style="color:#e6db74">&#34;</span>
                 (<span style="color:#a6e22e">buffer-name</span> buf))
           follow-link <span style="color:#66d9ef">t</span>
           <span style="color:#a6e22e">process-buffer</span> <span style="color:#f92672">,</span>buf
           action process-menu-visit-buffer)
             <span style="color:#e6db74">&#34;--&#34;</span>))
      (tty (or (<span style="color:#a6e22e">process-tty-name</span> p) <span style="color:#e6db74">&#34;--&#34;</span>))
      (cmd
       (if (<span style="color:#a6e22e">memq</span> type <span style="color:#f92672">&#39;</span>(network serial))
           (let ((contact (<span style="color:#a6e22e">process-contact</span> p <span style="color:#66d9ef">t</span>)))
             (if (<span style="color:#a6e22e">eq</span> type <span style="color:#e6db74">&#39;network</span>)
                 (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;(%s %s)&#34;</span>
                         (if (<span style="color:#a6e22e">plist-get</span> contact :type)
                             <span style="color:#e6db74">&#34;datagram&#34;</span>
                           <span style="color:#e6db74">&#34;network&#34;</span>)
                         (if (<span style="color:#a6e22e">plist-get</span> contact :server)
                             (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;server on %s&#34;</span>
                                     (or
                                      (<span style="color:#a6e22e">plist-get</span> contact :host)
                                      (<span style="color:#a6e22e">plist-get</span> contact :local)))
                           (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;connection to %s&#34;</span>
                                   (<span style="color:#a6e22e">plist-get</span> contact :host))))
               (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;(serial port %s%s)&#34;</span>
                       (or (<span style="color:#a6e22e">plist-get</span> contact :port) <span style="color:#e6db74">&#34;?&#34;</span>)
                       (let ((speed (<span style="color:#a6e22e">plist-get</span> contact :speed)))
                         (if speed
                             (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34; at %s b/s&#34;</span> speed)
                           <span style="color:#e6db74">&#34;&#34;</span>)))))
         (let* ((fullcmd (<span style="color:#a6e22e">mapconcat</span> <span style="color:#e6db74">&#39;e/q</span> (<span style="color:#a6e22e">process-command</span> p) <span style="color:#e6db74">&#34; &#34;</span>))
                (oneliner (replace-regexp-in-string <span style="color:#e6db74">&#34;\n&#34;</span> <span style="color:#e6db74">&#34;\\n&#34;</span> fullcmd <span style="color:#66d9ef">t</span> <span style="color:#66d9ef">t</span>))
                <span style="color:#75715e">;; This works but instead of trimming i want to turn everything into one line</span>
                <span style="color:#75715e">;; (fullcmdlen (length fullcmd))</span>
                <span style="color:#75715e">;; (shortcmd (substring fullcmd 0 (min fullcmdlen (window-total-width))))</span>
                )
           (<span style="color:#a6e22e">concat</span> <span style="color:#e6db74">&#34;{&#34;</span> oneliner <span style="color:#e6db74">&#34;}&#34;</span>) <span style="color:#75715e">; Surround with braces to allow selecting the command easily. Braces are also valid shell.</span>
           <span style="color:#75715e">;; shortcmd</span>
           ))))
       (push (<span style="color:#a6e22e">list</span> p (<span style="color:#a6e22e">vector</span> name pid status buf-label tty cmd))
             tabulated-list-entries)))))
  (tabulated-list-init-header))
</code></pre></div>
    </div>
    <div class="post-footer">
        <p>
        <a href="https://mullikine.github.io/about/">About this weblog</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://asciinema.org/~mullikine">Asciinema recordings</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/posts/blogs-and-vlogs/">Blogs and Vlogs</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/tags/">Site Map</a>
        </p>
    </div>
  </article>

    </main>
  </body>
</html>