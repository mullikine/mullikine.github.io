<!doctype html>
<html lang="en-us">
  <head>
    <title>Autoscaling GitLab Runner on AWS // Bodacious Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.82.0-DEV" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Shane Mulligan" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://mullikine.github.io/css/main.min.975c59c9290803aafebc5fb16d824ee90bda475ed1cf087d6e1a1a137cfb56fd.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Autoscaling GitLab Runner on AWS"/>
<meta name="twitter:description" content="Summary I design and put together an autoscaling GitLab Runner solution (which scales using EC2 Spot instances), along with a price analysis of options, for deploying ROS2 application source code to GitLab to be built and further deployed.
Creating this article and enabling AWS glossary  Glossary of GitLab CI/CD http://github.com/mullikine/glossaries-gh/blob/master/gitlab.txt   --  I automated the digestion of this reading material  [10/10] Read and done  https://docs.gitlab.com/runner/configuration/autoscale.html https://packages."/>

    <meta property="og:title" content="Autoscaling GitLab Runner on AWS" />
<meta property="og:description" content="Summary I design and put together an autoscaling GitLab Runner solution (which scales using EC2 Spot instances), along with a price analysis of options, for deploying ROS2 application source code to GitLab to be built and further deployed.
Creating this article and enabling AWS glossary  Glossary of GitLab CI/CD http://github.com/mullikine/glossaries-gh/blob/master/gitlab.txt   --  I automated the digestion of this reading material  [10/10] Read and done  https://docs.gitlab.com/runner/configuration/autoscale.html https://packages." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mullikine.github.io/posts/autoscaling-gitlab-runner-on-aws/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-05T00:00:00&#43;13:00" />
<meta property="article:modified_time" content="2020-01-05T00:00:00&#43;13:00" /><meta property="og:site_name" content="Bodacious Blog" />



    
    <script type="text/javascript">
      var _paq = window._paq = window._paq || [];
       
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://mullikine.matomo.cloud/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.src='//cdn.matomo.cloud/mullikine.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    

  </head>
  <body>
    <header class="app-header">

<a href="https://mullikine.github.io"><img class="app-header-avatar" src="http://mullikine.github.io/fievel.png" alt="Shane Mulligan" /></a>
      <h1>Bodacious Blog</h1>
      
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://linkedin.com/in/shane-mulligan-811b942b/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
        
          <a target="_blank" href="https://gitlab.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-gitlab">
  <title>gitlab</title>
  <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
        <a href="https://mullikine.github.io/cv/">CV</a>
      </div>
<div class="highlights">
<a href="https://mullikine.github.io/posts/practical-macros-in-racket-and-how-to-work-with-them/">Practical macros in Racket</a>
<br />
<a href="https://mullikine.github.io/posts/generating-hyperlinks-for-glossaries-and-other-parsers-in-emacs/">Hyperlink generation in emacs</a>
<br />
<a href="https://mullikine.github.io/posts/github-search-with-bigquery/">Searching GitHub with BigQuery</a>

<br />
<a href="https://mullikine.github.io/posts/review-of-the-case-for-learned-index-structures/">Case for Learned Index Structures</a>
<br />
<a href="https://mullikine.github.io/posts/arbitrary-interpreters-for-babel/">Arbitrary interpreters for Babel</a>
<br />
<a href="https://mullikine.github.io/glossary.html">Glossary A-Z (298 topics)</a> <a href="https://github.com/mullikine/glossaries-gh">code</a>
<br />
<a href="https://mullikine.github.io/posts/dwarf-fortress-macros-with-emacs-and-tmux/">Automating Dwarf Fortress</a>
<br />
<a href="https://mullikine.github.io/posts/review-of-the-illustrated-transformer/">The Illustrated Transformer</a>
<br />
<a href="https://mullikine.github.io/codelingo-vs-linters/summary/">CodeLingo vs Linters</a>
<br />
<a class="big" href="https://infogetics.github.io/">Infogetics on GitHub</a>
<br />
<a class="big" href="https://github.com/semiosis">Semiosis on GitHub</a>
<br />
<a class="big" href="https://takaheai.github.io/">TakaheAI on GitHub</a>
<br />
<div class="taglist">

  <a class="tag" href="https://mullikine.github.io/tags/gpt/">GPT (Generative Pre-trained Transformer)</a>
<a class="tag" href="https://mullikine.github.io/tags/biosemiotics/">biosemiotics</a>
<a class="tag" href="https://mullikine.github.io/tags/xenolinguistics/">xenolinguistics</a>
<a class="tag big" href="https://mullikine.github.io/tags/emacs/">emacs</a>
<a class="tag" href="https://mullikine.github.io/tags/elisp/">elisp</a>
<a class="tag" href="https://mullikine.github.io/tags/racket/">racket</a>
<a class="tag" href="https://mullikine.github.io/tags/haskell/">haskell</a>
<a class="tag" href="https://mullikine.github.io/tags/nlp/">NLP</a>
<a class="tag" href="https://mullikine.github.io/tags/docker/">docker</a>
<a class="tag" href="https://mullikine.github.io/tags/feature-engineering/">feature-engineering</a>
<a class="tag big" href="https://mullikine.github.io/tags/ir/">IR</a>
<a class="tag" href="https://mullikine.github.io/tags/games/">games</a>
<a class="tag" href="https://mullikine.github.io/tags/data/">data</a>
<a class="tag" href="https://mullikine.github.io/tags/info/">info theory</a>
<a class="tag" href="https://mullikine.github.io/tags/probability/">probability</a>
<a class="tag" href="https://mullikine.github.io/tags/problog/">problog</a>
<a class="tag big" href="https://mullikine.github.io/tags/shell/">shell</a>

<a class="tag" href="https://mullikine.github.io/tags/tooling/">tooling</a>
<a class="tag" href="https://mullikine.github.io/tags/iac/">IaC</a>
<a class="tag big" href="https://mullikine.github.io/tags/facebook/">Facebook</a>
<a class="tag" href="https://mullikine.github.io/tags/wfh/">WFH</a>


<a class="tag" href="https://mullikine.github.io/tags/babel/">babel</a>

<a class="tag" href="https://mullikine.github.io/tags/gcp/">GCP</a>
<a class="tag big" href="https://mullikine.github.io/tags/github/">GitHub</a>
<a class="tag" href="https://mullikine.github.io/tags/parsers/">parsers</a>
<a class="tag" href="https://mullikine.github.io/tags/rust/">rust</a>
<a class="tag" href="https://mullikine.github.io/tags/cpp/">c++</a>
<a class="tag" href="https://mullikine.github.io/tags/review/">review</a>
<a class="tag" href="https://mullikine.github.io/tags/kaggle/">kaggle</a>
<a class="tag" href="https://mullikine.github.io/tags/dl/">deep learning</a>
<a class="tag" href="https://mullikine.github.io/tags/dsl/">DSL</a>
<a class="tag" href="https://mullikine.github.io/tags/music/">music</a>
<a class="tag" href="https://mullikine.github.io/tags/df/">dwarf fortress</a>
<a class="tag" href="https://mullikine.github.io/tags/spacy/">spacy</a>
<a class="tag" href="https://mullikine.github.io/tags/latex/">latex</a>
<a class="tag" href="https://mullikine.github.io/tags/nix/">Nix</a>
<a class="tag" href="https://mullikine.github.io/tags/diagrams/">diagrams</a>
<a class="tag" href="https://mullikine.github.io/tags/python/">python</a>
<a class="tag" href="https://mullikine.github.io/tags/neural-engineering/">neural-engineering</a>
<a class="tag" href="https://mullikine.github.io/tags/golang/">golang</a>
<a class="tag" href="https://mullikine.github.io/tags/codelingo/">codelingo</a>
<a class="tag" href="https://mullikine.github.io/tags/aws/">AWS</a>
<a class="tag" href="https://mullikine.github.io/tags/perl/">perl</a>
<a class="tag big" href="https://mullikine.github.io/tags/vim/">vim</a>
<a class="tag" href="https://mullikine.github.io/tags/telco/">telco</a>
<a class="tag" href="https://mullikine.github.io/tags/automation/">automation</a>
<a class="tag" href="https://mullikine.github.io/tags/optimisation/">optimisation</a>
<a class="tag" href="https://mullikine.github.io/tags/release/">release</a>
<a class="tag" href="https://mullikine.github.io/tags/dotnet/">.NET</a>
<a class="tag" href="https://mullikine.github.io/tags/csharp/">csharp</a>
<a class="tag big" href="https://mullikine.github.io/tags/uber/">Uber</a>
<a class="tag" href="https://mullikine.github.io/tags/math/">math</a>
<a class="tag" href="https://mullikine.github.io/tags/microsoft/">Microsoft</a>
<a class="tag big" href="https://mullikine.github.io/tags/neuralink/">Neuralink</a>
<a class="tag big" href="https://mullikine.github.io/tags/openai/">OpenAI</a>
<a class="tag" href="https://mullikine.github.io/tags/terminals/">terminals</a>
<a class="tag" href="https://mullikine.github.io/tags/transformer/">transformer</a>
<a class="tag big" href="https://mullikine.github.io/tags/codegen/">code-gen</a>
<a class="tag" href="https://mullikine.github.io/tags/rosie/">rosie</a>
<a class="tag" href="https://mullikine.github.io/tags/terraform/">Terraform</a>
<a class="tag" href="https://mullikine.github.io/tags/elasticsearch/">ELK</a>
<a class="tag" href="https://mullikine.github.io/tags/semmle/">Semmle</a>
<a class="tag" href="https://mullikine.github.io/tags/expect/">tcl/expect</a>
<a class="tag" href="https://mullikine.github.io/tags/solr/">solr</a>
</div>
</div>



</div>
<div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <div class="post-footer phone">
      <p>
        <a href="https://mullikine.github.io/">Latest articles</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/tags/">Site Map</a>
      </p>
    </div>
    <header class="post-header">
      <h1 class ="post-title">Autoscaling GitLab Runner on AWS</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jan 5, 2020
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          21 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://mullikine.github.io/tags/gitlab/">gitlab</a><a class="tag" href="http://mullikine.github.io/tags/cicd/">cicd</a><a class="tag" href="http://mullikine.github.io/tags/aws/">aws</a><a class="tag" href="http://mullikine.github.io/tags/deployment/">deployment</a></div></div>
    </header>
    

<link rel="stylesheet" type="text/css" href="https://mullikine.github.io/css/magit.css"/>

<script src="https://mullikine.github.io/js/mathjax-config.js"></script>
 
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>


    <div class="post-content">
      <h2 id="summary">Summary</h2>
<p>I design and put together an autoscaling
GitLab Runner solution (which scales using EC2
Spot instances), along with a price analysis
of options, for deploying ROS2 application
source code to GitLab to be built and further
deployed.</p>
<h2 id="creating-this-article-and-enabling-aws-glossary">Creating this article and enabling AWS glossary</h2>
<dl>
<dt>Glossary of GitLab CI/CD</dt>
<dd><a href="http://github.com/mullikine/glossaries-gh/blob/master/gitlab.txt">http://github.com/mullikine/glossaries-gh/blob/master/gitlab.txt</a></dd>
</dl>
<!-- Play on asciinema.com -->
<!-- <a title="asciinema recording" href="https://asciinema.org/a/ANy5TTre35hkRaGAjoBQPSn1C" target="_blank"><img alt="asciinema recording" src="https://asciinema.org/a/ANy5TTre35hkRaGAjoBQPSn1C.svg" /></a> -->
<!-- Play on the blog -->
<script src="https://asciinema.org/a/ANy5TTre35hkRaGAjoBQPSn1C.js" id="asciicast-ANy5TTre35hkRaGAjoBQPSn1C" async></script>
<h2 id="i-automated-the-digestion-of-this-reading-material">I automated the digestion of this reading material</h2>
<ul>
<li><code>[10/10]</code> Read and done
<ul>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.gitlab.com/runner/configuration/autoscale.html">https://docs.gitlab.com/runner/configuration/autoscale.html</a></li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh">https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh</a></li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.gitlab.com/runner/configuration/runner%5Fautoscale%5Faws/">https://docs.gitlab.com/runner/configuration/runner%5Fautoscale%5Faws/</a>
<ul>
<li>This contains most of the setup procedure</li>
<li>notes
<ul>
<li>aws-security-groups</li>
</ul>
</li>
<li><a href="https://docs.docker.com/machine/drivers/aws/">https://docs.docker.com/machine/drivers/aws/</a></li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.gitlab.com/runner/install/linux-repository.html">https://docs.gitlab.com/runner/install/linux-repository.html</a></li>
<li>Install docker-machine
<ul>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.docker.com/machine/install-machine/">https://docs.docker.com/machine/install-machine/</a></li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/docker/machine/releases/download/v0.16.2">https://github.com/docker/machine/releases/download/v0.16.2</a></li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.gitlab.com/runner/register/index.html#gnulinux">https://docs.gitlab.com/runner/register/index.html#gnulinux</a></li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.gitlab.com/runner/install/registry%5Fand%5Fcache%5Fservers.html">https://docs.gitlab.com/runner/install/registry%5Fand%5Fcache%5Fservers.html</a>
<ul>
<li>cache installation using docker</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://www.enovate.co.uk/blog/2019/12/11/distributed-gitlab-runner-caching-with-minio">https://www.enovate.co.uk/blog/2019/12/11/distributed-gitlab-runner-caching-with-minio</a>
<ul>
<li>cache configuration</li>
<li>skip the deb installation</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.gitlab.com/runner/executors/docker%5Fmachine.html">https://docs.gitlab.com/runner/executors/docker%5Fmachine.html</a>
<ul>
<li>forked version of docker machine</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.gitlab.com/ee/ci/runners/">https://docs.gitlab.com/ee/ci/runners/</a></li>
<li><input checked="" disabled="" type="checkbox"> <a href="https://docs.docker.com/machine/drivers/aws/">https://docs.docker.com/machine/drivers/aws/</a></li>
</ul>
</li>
</ul>
<!--listend-->
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd $NOTES/ws/aws/gitlab-runner/pages
cat $NOTES/ws/aws/setup-gitlab-runner-manager.org | xurls | awk1 | <span style="color:#66d9ef">while</span> IFS<span style="color:#f92672">=</span><span style="color:#e6db74">$&#39;\n&#39;</span> read -r line; <span style="color:#66d9ef">do</span>
<span style="color:#f92672">(</span>
    exec 0&lt;/dev/tty
    slug<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>p <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> | slugify<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    ci elinks-dump <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$slug<span style="color:#e6db74">.txt&#34;</span>
<span style="color:#f92672">)</span>
<span style="color:#66d9ef">done</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="obtain-the-resources--tick-when-complete">Obtain the resources (tick when complete)</h2>
<ul>
<li><input checked="" disabled="" type="checkbox"> security group
<ul>
<li><input checked="" disabled="" type="checkbox"> Use default security groupp</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> EC2 instances
<ul>
<li><input checked="" disabled="" type="checkbox"> runnermanager server
<ul>
<li><input checked="" disabled="" type="checkbox"> t3 micro / small</li>
<li><input checked="" disabled="" type="checkbox"> General Purpose SSD (gp2) Volume
<ul>
<li>50GB</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Registry proxy server
<ul>
<li>This can run on the runnermanager instance</li>
<li><input checked="" disabled="" type="checkbox"> A port must be open</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> s3 cache server (for distributed cache)
<ul>
<li>Instead of using an s3 bucket, we can run a minio cache server on the same machine</li>
<li><input checked="" disabled="" type="checkbox"> A port must be open</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="design-the-system">Design the system</h2>
<ul>
<li>Runner manager
<ul>
<li>Executor: docker+machine</li>
<li>Docker image (used for gitlab-ci jobs): alpine:latest</li>
</ul>
</li>
<li>Use a distributed runners cache
<ul>
<li>This is required for incremental building</li>
</ul>
</li>
<li>distributed container registry mirror
<ul>
<li>This is required to cache docker images</li>
</ul>
</li>
<li>Use spot instances to cut down on costs
<ul>
<li>Through experimentation discover the best price threshold</li>
</ul>
</li>
</ul>
<h2 id="objectives">Objectives</h2>
<ul>
<li><code>[4/4]</code> Enable runner manager with autoscale
<ul>
<li><input checked="" disabled="" type="checkbox"> Install gitlab runner and docker machine on the same server
<ul>
<li><input checked="" disabled="" type="checkbox"> systemd for runner</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Use the AWS docker machine driver
<ul>
<li><a href="https://docs.gitlab.com/runner/configuration/autoscale.html#distributed-runners-caching">https://docs.gitlab.com/runner/configuration/autoscale.html#distributed-runners-caching</a></li>
<li><a href="https://docs.docker.com/machine/drivers/aws/">https://docs.docker.com/machine/drivers/aws/</a></li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Enable distributed runners cache</li>
<li><input checked="" disabled="" type="checkbox"> Enable distributed container registry mirror
<ul>
<li><input checked="" disabled="" type="checkbox"> Install registry proxy to its own server
<ul>
<li><a href="https://docs.gitlab.com/runner/install/registry%5Fand%5Fcache%5Fservers.html">https://docs.gitlab.com/runner/install/registry%5Fand%5Fcache%5Fservers.html</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="create-documentation">Create documentation</h2>
<h3 id="upgrading-the-runner">Upgrading the runner</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager

<span style="color:#75715e"># For systemd</span>
sudo systemctl stop gitlab-runner

<span style="color:#75715e"># Wait for the runner to exit</span>
sudo gitlab-runner status | grep running</code></pre></td></tr></table>
</div>
</div>
<h3 id="clearing-the-cache">Clearing the cache</h3>
<p><a href="https://docs.gitlab.com/ee/ci/caching/index.html#clearing-the-cache">https://docs.gitlab.com/ee/ci/caching/index.html#clearing-the-cache</a></p>
<h2 id="do-a-design-for-a-gitlab-runner-manager-on-aws">Do a design for a <code>gitlab-runner</code> manager on <code>AWS</code></h2>
<p>The <code>gilab-runner</code> will be installed using a
<code>deb</code>, rather than a <code>docker-container</code>,
<code>snap</code> or another method.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash</code></pre></td></tr></table>
</div>
</div>
<h3 id="requirements">Requirements</h3>
<h4 id="runnermanager-server"><code>runnermanager</code> server</h4>
<h4 id="dedicated-machine-where-the-container-registry-proxy-will-be-running">dedicated machine where the container registry proxy will be running</h4>
<!--list-separator-->
<ul>
<li>
<p>proxy container registry and a cache server to be used with the autoscaled Runners</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    docker pull registry:latest
    </code></pre></td></tr></table>
</div>
</div>
<p>Can I run this on the same server as the <code>runnermanager</code>? Probably.</p>
</li>
</ul>
<h4 id="ports-2376-and-22-are-accessible-by-the-runner-manager-instance-dot">ports 2376 and 22 are accessible by the Runner Manager instance.</h4>
<p><a href="https://docs.gitlab.com/runner/configuration/runner%5Fautoscale%5Faws/#aws-security-groups">https://docs.gitlab.com/runner/configuration/runner%5Fautoscale%5Faws/#aws-security-groups</a></p>
<p>Your GitLab instance is going to need to talk
to the Runners over the network, and that is
something you need think about when
configuring any AWS security groups or when
setting up your DNS configuration.</p>
<p>For example, you can keep the EC2 resources
segmented away from public traffic in a
different VPC to better strengthen your
network security. Your environment is likely
different, so consider what works best for
your situation.</p>
<p>AWS security groups</p>
<p>Docker Machine will attempt to use a default
security group with rules for port 2376 and
SSH 22, which is required for communication
with the Docker daemon. Instead of relying on
Docker, you can create a security group with
the rules you need and provide that in the
Runner options as we will see below. This way,
you can customize it to your liking ahead of
time based on your networking environment. You
have to make sure that ports 2376 and 22 are
accessible by the Runner Manager instance.</p>
<h3 id="find-out-what-i-need-to-read"><span class="org-todo done DONE">DONE</span> Find out what I need to read</h3>
<p>Digest them methodically.</p>
<h4 id="register-gitlab-runner-for-autoscaling-with-docker-machine"><span class="org-todo done DONE">DONE</span> register GitLab Runner for autoscaling with Docker Machine</h4>
<p><a href="https://docs.gitlab.com/runner/executors/docker_machine.html">https://docs.gitlab.com/runner/executors/docker_machine.html</a></p>
<ul>
<li>Log in to a new Linux-based machine that will serve as a bastion
server where Docker will spawn new machines from</li>
<li>Install GitLab Runner</li>
<li>Install Docker Machine</li>
<li>Optionally but recommended, prepare a proxy container registry and a
cache server to be used with the autoscaled Runners</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Install runner</p>
<p><a href="https://docs.gitlab.com/runner/install/linux-repository.html">https://docs.gitlab.com/runner/install/linux-repository.html</a></p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Install docker machine</p>
<p><a href="https://docs.docker.com/machine/install-machine/">https://docs.docker.com/machine/install-machine/</a></p>
<p>Use latest version <code>v0.16.2</code> available here <a href="https://github.com/docker/machine/releases/">https://github.com/docker/machine/releases/</a>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    base<span style="color:#f92672">=</span>https://github.com/docker/machine/releases/download/v0.16.2 <span style="color:#f92672">&amp;&amp;</span>
        curl -L $base/docker-machine-<span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span>-<span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span> &gt;/tmp/docker-machine <span style="color:#f92672">&amp;&amp;</span>
        sudo mv /tmp/docker-machine /usr/local/bin/docker-machine <span style="color:#f92672">&amp;&amp;</span>
        chmod +x /usr/local/bin/docker-machine
    </code></pre></td></tr></table>
</div>
</div>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Set up docker machine</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    ssh runnermanager
    docker-machine create
    </code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    hsqf docker-machine create
    </code></pre></td></tr></table>
</div>
</div>
<p><a href="https://docs.gitlab.com/runner/configuration/autoscale.html">https://docs.gitlab.com/runner/configuration/autoscale.html</a></p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Configuring GitLab Runner</p>
 <!--list-separator-->
<ul>
<li>
<p>Register the runner</p>
<p><a href="https://docs.gitlab.com/runner/register/index.html#gnulinux">https://docs.gitlab.com/runner/register/index.html#gnulinux</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">        v +/<span style="color:#e6db74">&#34;#  --executor \&#34;docker\&#34; \\\\&#34;</span> <span style="color:#e6db74">&#34;</span>$SCRIPTS<span style="color:#e6db74">/gitlab-runner-regiser-token&#34;</span>
        </code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">        ssh runnermanager
        export CI_SERVER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
        export RUNNER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;aws-runnermanager&#34;</span>
        export REGISTRATION_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;3vTEcZiFaDgUUU_-ZE7c&#34;</span>
        export REGISTER_NON_INTERACTIVE<span style="color:#f92672">=</span>true

        rm -rf ~/.gitlab-runner/
        gitlab-runner register --docker-image alpine --executor <span style="color:#e6db74">&#34;docker+machine&#34;</span> <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
        </code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">        ssh runnermanager
        gitlab-runner list 2&gt;&amp;<span style="color:#ae81ff">1</span> | less -rS
        </code></pre></td></tr></table>
</div>
</div>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Set up docker registry cache</p>
<p><a href="https://docs.gitlab.com/runner/install/registry%5Fand%5Fcache%5Fservers.html">https://docs.gitlab.com/runner/install/registry%5Fand%5Fcache%5Fservers.html</a></p>
</li>
</ul>
<h4 id="optimisation">Optimisation</h4>
<p><a href="https://docs.gitlab.com/runner/executors/docker%5Fmachine.html#forked-version-of-docker-machine">https://docs.gitlab.com/runner/executors/docker%5Fmachine.html#forked-version-of-docker-machine</a></p>
<h3 id="fill-out-task">Fill out task</h3>
<h4 id="design">Design</h4>
<!--list-separator-->
<ul>
<li>
<p>Enter the config</p>
<p>$HOME/.gitlab-runner/config.toml</p>
</li>
</ul>
<h4 id="implementation">Implementation</h4>
<p><code>gilab-runner</code> will be installed using a
<code>deb</code>, rather than a <code>docker-container</code>,
<code>snap</code> or another method.</p>
<!--list-separator-->
<ul>
<li>
<p>Obtain runner token</p>
<p><a href="https://docs.gitlab.com/ee/ci/runners/">https://docs.gitlab.com/ee/ci/runners/</a></p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Register runner</p>
<p><a href="https://docs.gitlab.com/runner/register/index.html#gnulinux">https://docs.gitlab.com/runner/register/index.html#gnulinux</a></p>
<p>$SCRIPTS/gitlab-runner-regiser-token</p>
<p>docker+machine</p>
</li>
</ul>
<h3 id="tonight-definitely-try-to-get-this-going"><span class="org-todo done DONE">DONE</span> Tonight definitely try to get this going</h3>
<p><a href="https://docs.gitlab.com/runner/configuration/runner_autoscale_aws/">https://docs.gitlab.com/runner/configuration/runner_autoscale_aws/</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">eww <span style="color:#e6db74">&#34;https://docs.gitlab.com/runner/configuration/runner_autoscale_aws/&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="skip-read-through-this"><span class="org-todo done DONE">DONE</span> Skip read through this</h4>
<p><a href="https://docs.docker.com/machine/drivers/aws/">https://docs.docker.com/machine/drivers/aws/</a></p>
<h2 id="perform-some-benchmarking"><span class="org-todo done DONE">DONE</span> Perform some benchmarking</h2>
<table>
<thead>
<tr>
<th>machine</th>
<th>time</th>
</tr>
</thead>
<tbody>
<tr>
<td>tiny</td>
<td>N/A</td>
</tr>
<tr>
<td>m5.2xlarge</td>
<td>13.5 min</td>
</tr>
<tr>
<td>shared runner</td>
<td>47 min</td>
</tr>
<tr>
<td>laptop 16 cores</td>
<td>6.5 min</td>
</tr>
<tr>
<td>laptop 8 cores</td>
<td>8.5 min</td>
</tr>
</tbody>
</table>
<h3 id="runnermanager--tiny"><code>runnermanager</code> (tiny)</h3>
<p>The runnermanager isntance did not have the disk space to run the
pipeline.</p>
<p>It currently has 5.5GB of free disk space.</p>
<p>This is significant because a pipeline must be a more powerful machine
than this.</p>
<h3 id="testrunner--m5-dot-2xlarge"><code>testrunner</code> (m5.2xlarge)</h3>
<h4 id="the-full-pipeline-takes-00-13-26">The full pipeline takes <code>00:13:26</code></h4>
<ul>
<li>The cached image took 3 seconds to download.</li>
<li>With caching, build incremental build time could be only 3 mins.</li>
</ul>
<!--listend-->
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Duration: 10 minutes 36 seconds
Timeout: 1h (from project)

Runner: aws-testrunner (#2018378)</code></pre></td></tr></table>
</div>
</div>
<h3 id="shared-runner">shared runner</h3>
<h4 id="the-full-pipeline-takes-00-46-47-on">The full pipeline takes <code>00:46:47</code> on</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">00:46:47

56 minutes ago</code></pre></td></tr></table>
</div>
</div>
<h3 id="neli-laptop"><code>neli</code> / laptop</h3>
<ul>
<li>Can&rsquo;t get the same speed gains with a laptop pool.</li>
<li>Takes an extra 1.5 mins to upload the alv project artifact (2GB)</li>
</ul>
<h4 id="16-cpus--current-max">16 cpus (current max)</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Duration: 5 minutes 11 seconds
Timeout: 1h (from project)

Runner: aws-neli (#2033480)</code></pre></td></tr></table>
</div>
</div>
<h4 id="8-cpus">8 cpus</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Duration: 7 minutes 18 seconds
Timeout: 1h (from project)

Runner: aws-neli (#2033480)</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd <span style="color:#e6db74">&#34;</span>$NOTES<span style="color:#e6db74">/ws/aws/gitlab-runner/pages&#34;</span>; ead config.toml</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd <span style="color:#e6db74">&#34;</span>$NOTES<span style="color:#e6db74">/ws/aws/gitlab-runner/pages&#34;</span>; ead --executor</code></pre></td></tr></table>
</div>
</div>
<h3 id="create-a-script-for-setting-up-a-new-runner"><span class="org-todo done DONE">DONE</span> Create a script for setting up a new runner</h3>
<ul>
<li>Don&rsquo;t set it up to <code>autoscale</code></li>
</ul>
<p>Simply set up the basic runner configuration.</p>
<h4 id="install-docker-add-group-restart"><span class="org-todo done DONE">DONE</span> install docker, add group, restart</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># On my laptop</span>
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;testrunner&#34;</span>

ssh $host

host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;testrunner&#34;</span>
token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--------------------&#34;</span>
export CI_SERVER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
export RUNNER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;aws-</span>$host<span style="color:#e6db74">&#34;</span>
export REGISTRATION_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$token<span style="color:#e6db74">&#34;</span>
export REGISTER_NON_INTERACTIVE<span style="color:#f92672">=</span>true

sudo apt install -y docker.io
sudo systemctl start docker
sudo groupadd docker
sudo usermod -aG docker $USER

sudo shutdown -r now

rssh $host
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;testrunner&#34;</span>
token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--------------------&#34;</span>
export CI_SERVER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
export RUNNER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;aws-</span>$host<span style="color:#e6db74">&#34;</span>
export REGISTRATION_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$token<span style="color:#e6db74">&#34;</span>
export REGISTER_NON_INTERACTIVE<span style="color:#f92672">=</span>true</code></pre></td></tr></table>
</div>
</div>
<h4 id="set-up-testrunner">Set up <code>testrunner</code></h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># On my laptop</span>
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;testrunner&#34;</span>

ssh $host

<span style="color:#75715e"># On the host</span>
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;testrunner&#34;</span>

token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--------------------&#34;</span>

sudo update-locale LANG<span style="color:#f92672">=</span>en_US.UTF-8 LANGUAGE<span style="color:#f92672">=</span>en_US
sudo locale-gen en_AU.UTF-8

<span style="color:#75715e"># Install gitlab-runner</span>
<span style="color:#75715e"># https://docs.gitlab.com/runner/install/linux-repository.html</span>
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
sudo apt-get install gitlab-runner

<span style="color:#75715e"># This is required if we are to run docker on this machine</span>
sudo apt install -y docker.io
sudo systemctl start docker
sudo groupadd docker
sudo usermod -aG docker $USER

sudo apt update

export CI_SERVER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
export RUNNER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;aws-</span>$host<span style="color:#e6db74">&#34;</span>
export REGISTRATION_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$token<span style="color:#e6db74">&#34;</span>
export REGISTER_NON_INTERACTIVE<span style="color:#f92672">=</span>true

<span style="color:#75715e"># gitlab-runner register --docker-image alpine --executor &#34;docker+machine&#34;</span>

sudo gitlab-runner stop
<span style="color:#75715e"># gitlab-runner register --tag-list &#34;docker,aws&#34; --docker-image alpine --executor &#34;docker&#34;</span>

rm -rf ~/.gitlab-runner/
gitlab-runner register --docker-image alpine --executor <span style="color:#e6db74">&#34;docker&#34;</span>
sudo gitlab-runner start</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh testrunner

sudo gitlab-runner --debug run</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">gitlab-runner --debug run --config /etc/gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<h4 id="set-up-docker-cache-proxy-server">Set up docker cache proxy server</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager

sudo apt install -y docker.io
sudo systemctl start docker
sudo groupadd docker
sudo usermod -aG docker $USER

<span style="color:#75715e"># This would clear the cache, probably</span>
docker container rm registry
<span style="color:#75715e"># Start registry on port 6000</span>
<span style="color:#75715e">#    -e REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io \</span>
docker run -d -p 6000:5000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -e REGISTRY_PROXY_REMOTEURL<span style="color:#f92672">=</span>https://registry.gitlab.com <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --restart always <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --name registry registry:2</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager
sudo groupadd docker
sudo usermod -aG docker $USER</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager
sudo apt install -y nmap
nmap -sT localhost</code></pre></td></tr></table>
</div>
</div>
<p>You should preferably choose the private
networking IP address.</p>
<p>The private networking is usually the fastest
solution for internal communication between
machines of a single provider (DigitalOcean,
AWS, Azure, etc)</p>
<p>Usually the private networking is also not
accounted to your monthly bandwidth limit.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager
hostname --ip-address</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager
vim /home/ubuntu/.gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<p>&lt;/ssh:runnermanager:/home/ubuntu/.gitlab-runner/config.toml&gt;</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager
vim ~/.gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<h4 id="set-up-gitlab-cache-server">Set up gitlab cache server</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">DOCKER_WRAPPER_REMOTE_HOST<span style="color:#f92672">=</span>runnermanager docker container stop minio</code></pre></td></tr></table>
</div>
</div>
<!--list-separator-->
<ul>
<li>
<p>This is how I should run it</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    ssh runnermanager

    <span style="color:#75715e"># Set up minio on port 9005</span>
    docker run -d -it --restart always -p 9005:9000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          -v /.minio:/root/.minio -v /export:/export <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          --name minio <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          --restart always <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>          minio/minio:latest server /export

    sudo mkdir -p /export/gitlab-runner-cache
    </code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    v +/<span style="color:#e6db74">&#34;sudo mkdir .export&#34;</span> <span style="color:#e6db74">&#34;</span>$NOTES<span style="color:#e6db74">/ws/aws/gitlab-runner/pages/https-docs-gitlab-com-runner-install-registry-and-cache-servers-html.txt&#34;</span>
    </code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    ssh runnermanager

    <span style="color:#75715e"># This actually creates a bucket called =gitlab-runner-cache=. No need for =mc mb=</span>
    sudo mkdir -p /export/gitlab-runner-cache

    sudo cat /export/.minio.sys/config/config.json | grep Key
    </code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    ssh runnermanager sudo cat /export/.minio.sys/config/config.json | jiq
    </code></pre></td></tr></table>
</div>
</div>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Follow this guide</p>
<p><a href="https://www.enovate.co.uk/blog/2019/12/11/distributed-gitlab-runner-caching-with-minio">https://www.enovate.co.uk/blog/2019/12/11/distributed-gitlab-runner-caching-with-minio</a></p>
<p>It turns out that <code>BucketName = &quot;gitlab-runner&quot;</code> is created within <code>minio</code>.</p>
<p>I&rsquo;m not sure about <code>BucketLocation</code> though. It might be arbitrary.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Make some commands for accessing the cache</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">    Browser Access:
       http://172.17.0.3:9000  http://127.0.0.1:9000

    Command-line Access: https://docs.min.io/docs/minio-client-quickstart-guide
       $ mc config host add myminio http://172.17.0.3:9000 ---- ----
    </code></pre></td></tr></table>
</div>
</div>
</li>
</ul>
<h3 id="runnermanager-server"><span class="org-todo done DONE">DONE</span> runnermanager server</h3>
<h3 id="shared-runners"><span class="org-todo done DONE">DONE</span> shared runners</h3>
<h3 id="laptop"><span class="org-todo done DONE">DONE</span> laptop</h3>
<h3 id="c5-extra-large--beast"><span class="org-todo done DONE">DONE</span> c5 extra large (beast)</h3>
<ul>
<li>set up runner</li>
<li>build</li>
</ul>
<h2 id="isolate-a-specific-runner-for-testing"><span class="org-todo done DONE">DONE</span> Isolate a specific runner for testing</h2>
<p><a href="https://stackoverflow.com/questions/47059975/gitlab-is-it-possible-to-run-pipeline-on-a-specific-runner">https://stackoverflow.com/questions/47059975/gitlab-is-it-possible-to-run-pipeline-on-a-specific-runner</a></p>
<h2 id="use-my-own-fork-the-project-in-order-to-test-a-new-dot-gitlab-ci-dot-yml-file"><span class="org-todo done DONE">DONE</span> Use my own fork the project in order to test a new <code>.gitlab-ci.yml</code> file</h2>
<h3 id="i-had-to-export-and-import-instead-of-fork">I had to export and import instead of fork</h3>
<h2 id="ensure-the-runner-i-m-using-is-using-its-own-caches"><span class="org-todo done DONE">DONE</span> Ensure the runner I&rsquo;m using is using its own caches</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd <span style="color:#e6db74">&#34;</span>$NOTES<span style="color:#e6db74">/ws/aws/gitlab-runner/pages&#34;</span>; ead --executor</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd <span style="color:#e6db74">&#34;</span>$NOTES<span style="color:#e6db74">/ws/aws/gitlab-runner/pages&#34;</span>; ead runners.cache</code></pre></td></tr></table>
</div>
</div>
<h2 id="test-bug">Test bug</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">eval <span style="color:#66d9ef">$(</span>ssh-agent -s<span style="color:#66d9ef">)</span>
GIT_SSH_PRIV_KEY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat /home/shane/.ssh/ids/alv-git-deploy-key<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
ssh-add &lt;<span style="color:#f92672">(</span>echo <span style="color:#e6db74">&#34;</span>$GIT_SSH_PRIV_KEY<span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
echo <span style="color:#e6db74">&#34;</span>$GIT_SSH_PRIV_KEY<span style="color:#e6db74">&#34;</span> | sed <span style="color:#e6db74">&#39;s/./_/g&#39;</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="find-out-why-gitlab-runner-not-getting-variable"><span class="org-todo done DONE">DONE</span> Find out why gitlab-runner not getting variable</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">egr gitlab-runner not getting variable</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">https://gitlab.com/help/ci/variables/README#variables

Whenever a variable is protected, it would
only be securely passed to pipelines running
on the protected branches or protected tags.

But that seems to be false, in my case.

The branch AND tag must be protected for the
variable to be accessible.</code></pre></td></tr></table>
</div>
</div>
<h2 id="try-to-get-gitlab-interactive-web-terminal-going"><span class="org-todo done DONE">DONE</span> Try to get gitlab interactive web terminal going</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">egr gitlab interactive web terminal</code></pre></td></tr></table>
</div>
</div>
<p>This might be more difficult as ports need to be opened.</p>
<h2 id="if-the-pipeline-is-stuck">If the pipeline is stuck:</h2>
<h3 id="edit-the-runner-from-the-cicd-settings">Edit the runner from the CICD settings</h3>
<ul>
<li>remove the tags</li>
<li>check the box that allows the runner to pick up untagged jobs
<code>Run untagged jobs</code></li>
<li>either ensure <code>master</code> branch is protected or check the box that allows the runner to take jobs for unprotected branches</li>
</ul>
<h2 id="do-some-benchmarks"><span class="org-todo done DONE">DONE</span> Do some benchmarks</h2>
<p><a href="https://docs.gitlab.com/runner/monitoring/">https://docs.gitlab.com/runner/monitoring/</a></p>
<h3 id="my-own-metrics">My own metrics</h3>
<h4 id="set-up-prometheus"><span class="org-todo done DONE">DONE</span> Set up prometheus</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">egr gitlab-runner metrics</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">egr gitlab-runner prometheus</code></pre></td></tr></table>
</div>
</div>
<p><a href="https://gitlab.com/gitlab-org/gitlab-runner/-/merge%5Frequests/1545">https://gitlab.com/gitlab-org/gitlab-runner/-/merge%5Frequests/1545</a></p>
<p><a href="https://docs.gitlab.com/ee/administration/monitoring/prometheus/gitlab%5Fmetrics.html">https://docs.gitlab.com/ee/administration/monitoring/prometheus/gitlab%5Fmetrics.html</a></p>
<h3 id="gitlab-premium">GitLab premium</h3>
<p><a href="https://docs.gitlab.com/ee/ci/metrics%5Freports.html">https://docs.gitlab.com/ee/ci/metrics%5Freports.html</a></p>
<h2 id="metrics">Metrics</h2>
<h3 id="runnermanager--tiny"><code>runnermanager</code> (tiny)</h3>
<h4 id="set-up-runnermanager--for-benchmarking">Set up <code>runnermanager</code> (for benchmarking)</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># On my laptop</span>
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;runnermanager&#34;</span>

ssh $host

<span style="color:#75715e"># On the host</span>
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;runnermanager&#34;</span>

token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--------------------&#34;</span>

sudo update-locale LANG<span style="color:#f92672">=</span>en_US.UTF-8 LANGUAGE<span style="color:#f92672">=</span>en_US
sudo locale-gen en_AU.UTF-8

<span style="color:#75715e"># Install gitlab-runner</span>
<span style="color:#75715e"># https://docs.gitlab.com/runner/install/linux-repository.html</span>
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
sudo apt-get install gitlab-runner

<span style="color:#75715e"># This is required if we are to run docker on this machine</span>
sudo apt install -y docker.io
sudo systemctl start docker
sudo groupadd docker
sudo usermod -aG docker $USER

sudo apt update

export CI_SERVER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
export RUNNER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;aws-</span>$host<span style="color:#e6db74">&#34;</span>
export REGISTRATION_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$token<span style="color:#e6db74">&#34;</span>
export REGISTER_NON_INTERACTIVE<span style="color:#f92672">=</span>true

<span style="color:#75715e"># gitlab-runner register --docker-image alpine --executor &#34;docker+machine&#34;</span>

rm -rf ~/.gitlab-runner/

<span style="color:#75715e"># gitlab-runner register --tag-list &#34;docker,aws&#34; --docker-image alpine --executor &#34;docker&#34;</span>
gitlab-runner register --docker-image <span style="color:#e6db74">&#34;</span>$registry_url<span style="color:#e6db74">&#34;</span> --executor <span style="color:#e6db74">&#34;docker&#34;</span>
<span style="color:#75715e"># gitlab-runner register --docker-image alpine --executor &#34;docker&#34;</span>
<span style="color:#75715e"># sudo gitlab-runner start</span>

sudo gitlab-runner --debug run --config ~/.gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager

sudo gitlab-runner --debug run</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">gitlab-runner --debug run --config /etc/gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo gitlab-runner --debug run --config ~/.gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<h3 id="testrunner"><code>testrunner</code></h3>
<h4 id="the-full-pipeline-takes-00-13-26">The full pipeline takes <code>00:13:26</code></h4>
<ul>
<li>The cached image took 3 seconds to download.</li>
<li>With caching, build incremental build time could be only 3 mins.</li>
</ul>
<!--listend-->
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Duration: 10 minutes 36 seconds
Timeout: 1h (from project)

Runner: aws-testrunner (#2018378)</code></pre></td></tr></table>
</div>
</div>
<h4 id="the-full-pipeline-takes-00-46-47-on-shared-runners">The full pipeline takes <code>00:46:47</code> on shared runners</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">00:46:47

56 minutes ago</code></pre></td></tr></table>
</div>
</div>
<h3 id="neli-laptop"><code>neli</code> / laptop</h3>
<h4 id="16-cpus--current-max">16 cpus (current max)</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Duration: 5 minutes 11 seconds
Timeout: 1h (from project)

Runner: aws-neli (#2033480)</code></pre></td></tr></table>
</div>
</div>
<h4 id="8-cpus">8 cpus</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Duration: 7 minutes 18 seconds
Timeout: 1h (from project)

Runner: aws-neli (#2033480)</code></pre></td></tr></table>
</div>
</div>
<h4 id="set-up-neli--for-benchmarking">Set up <code>neli</code> (for benchmarking)</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># On my laptop</span>
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;neli&#34;</span>

ssh $host

<span style="color:#75715e"># On the host</span>
host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;neli&#34;</span>

token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--------------------&#34;</span>

sudo update-locale LANG<span style="color:#f92672">=</span>en_US.UTF-8 LANGUAGE<span style="color:#f92672">=</span>en_US
sudo locale-gen en_AU.UTF-8

<span style="color:#75715e"># Install gitlab-runner</span>
<span style="color:#75715e"># https://docs.gitlab.com/runner/install/linux-repository.html</span>
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
sudo apt-get install gitlab-runner

<span style="color:#75715e"># This is required if we are to run docker on this machine</span>
sudo apt install -y docker.io
sudo systemctl start docker
sudo groupadd docker
sudo usermod -aG docker $USER

sudo apt update

export CI_SERVER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
export RUNNER_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$host<span style="color:#e6db74">&#34;</span>
export REGISTRATION_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$token<span style="color:#e6db74">&#34;</span>
export REGISTER_NON_INTERACTIVE<span style="color:#f92672">=</span>true

<span style="color:#75715e"># gitlab-runner register --docker-image alpine --executor &#34;docker+machine&#34;</span>

sudo gitlab-runner stop

rm -rf ~/.gitlab-runner/
rm -rf ~/.docker/

<span style="color:#75715e"># Docker must be properly installed by the time I register the runner, or it wont be authorised to pull images from docker</span>
<span style="color:#75715e"># How to guarantee it&#39;s authorised</span>

<span style="color:#75715e"># gitlab-runner register --tag-list &#34;docker,aws&#34; --docker-image alpine --executor &#34;docker&#34;</span>
gitlab-runner register --docker-image <span style="color:#e6db74">&#34;</span>$registryurl<span style="color:#e6db74">&#34;</span> --executor <span style="color:#e6db74">&#34;docker&#34;</span>
<span style="color:#75715e"># gitlab-runner register --docker-image alpine --executor &#34;docker&#34;</span>
<span style="color:#75715e"># sudo gitlab-runner start</span>

sudo gitlab-runner --debug run --config ~/.gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh neli

sudo gitlab-runner --debug run</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">gitlab-runner --debug run --config /etc/gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo gitlab-runner --debug run --config ~/.gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<h2 id="i-think-the-problem-with-gitlab-runner-needing-docker-login-i-think-is-due-to-the-fact-that-our-runner-is-spawned-by-us">I think the problem with gitlab-runner needing docker login I think is due to the fact that our runner is spawned by us</h2>
<p><a href="https://docs.gitlab.com/ee/user/packages/container%5Fregistry/#container-registry-examples-with-gitlab-cicd">https://docs.gitlab.com/ee/user/packages/container%5Fregistry/#container-registry-examples-with-gitlab-cicd</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager
docker login --username mygitlabuser --password-stdin registry.gitlab.com</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>It would be nice to eliminate the time of failed login</li>
</ul>
<h3 id="reclaim-disk-space">Reclaim disk space</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker system prune</code></pre></td></tr></table>
</div>
</div>
<h2 id="we-don-t-need-a-docker-cache-if-we-keep-the-runner-alive">We don&rsquo;t need a docker cache if we keep the runner alive</h2>
<h2 id="it-s-possible-to-eliminate-the-downloading-of-docker-images-entirely-by-using-individual-runners">It&rsquo;s possible to eliminate the downloading of docker images entirely by using individual runners</h2>
<h2 id="make-it-so-the-pipeline-may-run-on-a-laptop"><span class="org-todo done DONE">DONE</span> Make it so the pipeline may run on a laptop</h2>
<h2 id="make-it-so-the-yaml-expands-into-2-jobs-pipelines"><span class="org-todo done DONE">DONE</span> Make it so the yaml expands into 2 jobs / pipelines</h2>
<ul>
<li>one tag must be high performance</li>
<li>shared</li>
</ul>
<h2 id="make-a-script-that-turns-your-own-machine-into-a-gitlab-runner"><span class="org-todo done DONE">DONE</span> Make a script that turns your own machine into a gitlab runner</h2>
<p>Ideally, this would use <code>docker-compose</code>.
But make it firstly with my own script.</p>
<h3 id="make-it-set-up-minio-if-you-want-too">Make it set up minio if you want, too</h3>
<p>Enable incremental building.</p>
<p>No need for docker cache.</p>
<h2 id="set-the-max-number-of-cpus"><span class="org-todo done DONE">DONE</span> Set the max number of CPUs</h2>
<p><a href="https://gitlab.com/gitlab-org/gitlab-runner/issues/3767">https://gitlab.com/gitlab-org/gitlab-runner/issues/3767</a></p>
<p><code>cpuset</code> is currently the best I can figure out how.</p>
<p>This works and it uses exactly half.</p>
<p>This leaves the laptop in a usable state.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="color:#a6e22e">concurrent</span> = <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">check_interval</span> = <span style="color:#ae81ff">0</span>

[<span style="color:#a6e22e">session_server</span>]
  <span style="color:#a6e22e">session_timeout</span> = <span style="color:#ae81ff">1800</span>

[[<span style="color:#a6e22e">runners</span>]]
  <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;aws-neli&#34;</span>
  <span style="color:#a6e22e">url</span> = <span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
  <span style="color:#a6e22e">token</span> = <span style="color:#e6db74">&#34;--------------------&#34;</span>
  <span style="color:#a6e22e">executor</span> = <span style="color:#e6db74">&#34;docker&#34;</span>
  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">custom_build_dir</span>]
  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">cache</span>]
    [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">s3</span>]
    [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">gcs</span>]
  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">docker</span>]
    <span style="color:#a6e22e">tls_verify</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">image</span> = <span style="color:#e6db74">&#34;---------------------------------------------------------&#34;</span>
    <span style="color:#a6e22e">privileged</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">disable_entrypoint_overwrite</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">oom_kill_disable</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">disable_cache</span> = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">volumes</span> = [<span style="color:#e6db74">&#34;/cache&#34;</span>]
    <span style="color:#a6e22e">shm_size</span> = <span style="color:#ae81ff">0</span>
    <span style="color:#a6e22e">cpuset_cpus</span> = <span style="color:#e6db74">&#34;0-7&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="make-the-issue-and-have-it-ready-before-tomorrow"><span class="org-todo done DONE">DONE</span> Make the issue and have it ready before tomorrow</h2>
<h3 id="create-the-script-for-setting-up-an-arbitrary-new-machine">Create the script for setting up an arbitrary new machine</h3>
<p>Do it without restarting, by using <code>login</code> or <code>ssh</code>.</p>
<p>Actually, use <code>ssh</code> because that way I can use a control socket.</p>
<p>Create the script tonight.</p>
<h2 id="figure-out-how-to-run-only-the-jobs-with-a-specific-tag"><span class="org-todo done DONE">DONE</span> Figure out how to run <strong>only</strong> the jobs with a specific tag</h2>
<h3 id="set-up-runner"><span class="org-todo done DONE">DONE</span> Set up runner</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">egr gitlab-ci run only jobs with tag</code></pre></td></tr></table>
</div>
</div>
<h3 id="set-up-jobs"><span class="org-todo done DONE">DONE</span> Set up jobs</h3>
<h4 id="create-identical-jobs-with-tags">Create identical jobs with tags</h4>
<h4 id="create-a-way-to-by-default">Create a way to, by default</h4>
<h2 id="figure-out-how-to-share-artifacts-from-one-runner-to-the-next"><span class="org-todo done DONE">DONE</span> Figure out how to share artifacts from one runner to the next</h2>
<p>Not possible without <span class="underline">sticky runners</span> which are not implemented.</p>
<p><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/17497">https://gitlab.com/gitlab-org/gitlab/-/issues/17497</a></p>
<p>It would be very fast to use a dedicated machine to do all jobs.</p>
<h2 id="figure-out-where-artifacts-are-stored"><span class="org-todo done DONE">DONE</span> Figure out where artifacts are stored</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">egr where are runner artifacts stored</code></pre></td></tr></table>
</div>
</div>
<h2 id="do-some-end-to-end-speed-tests"><span class="org-todo done DONE">DONE</span> Do some end-to-end speed tests</h2>
<ul>
<li>laptop only
Quite slow.</li>
</ul>
<p><code>checkout-alv</code> takes 10 mins where on aws it takes 3.
This is because of network delays.</p>
<h2 id="if-using-laptop">If using laptop</h2>
<h3 id="the-pipeline-would-have-to-be-modified-to-fetch-pull-rather-than-clone-dot">The pipeline would have to be modified to fetch/pull rather than clone.</h3>
<p>Artifacts would have to be disabled.
The full <code>alv</code> bundle can&rsquo;t be used as an artifact.</p>
<ul>
<li>large instance only</li>
</ul>
<h2 id="finish-the-script-for-setting-up-a-runner"><span class="org-todo done DONE">DONE</span> Finish the script for setting up a <span class="underline">stand-alone</span> runner</h2>
<ul>
<li>consolidate the babel blocks above</li>
<li>ensure <code>x</code> exports its environment</li>
</ul>
<p>$SCRIPTS/setup-solo-runner.sh
$SCRIPTS/setup-solo-runner.xsh</p>
<h2 id="make-a-script-for-setting-up-a-runner-as-a-manager"><span class="org-todo done DONE">DONE</span> Make a script for setting up a runner as a manager</h2>
<h3 id="set-autoscale-parameters">Set autoscale parameters</h3>
<ul>
<li>
<p><code>IdleCount = 0</code>.
It&rsquo;s expensive to leave these online.</p>
</li>
<li>
<p><code>IdleTime = 600</code>
Shut down the machines after 10 mins of inactivity.</p>
</li>
</ul>
<!--listend-->
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="color:#a6e22e">concurrent</span>=<span style="color:#ae81ff">2</span>

[[<span style="color:#a6e22e">runners</span>]]
  <span style="color:#a6e22e">limit</span> = <span style="color:#ae81ff">2</span>
  <span style="color:#75715e"># (...)</span>
  <span style="color:#a6e22e">executor</span> = <span style="color:#e6db74">&#34;docker+machine&#34;</span>
  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">machine</span>]
    <span style="color:#a6e22e">IdleCount</span> = <span style="color:#ae81ff">0</span>
    <span style="color:#a6e22e">IdleTime</span> = <span style="color:#ae81ff">600</span>
    <span style="color:#75715e"># (...)</span></code></pre></td></tr></table>
</div>
</div>
<p>Concurrent and limit set to values that will
run the maximum count of machines you are
willing to pay for. As for IdleCount, it
should be set to a value that will generate a
minimum amount of not used machines when the
job queue is empty.</p>
<h3 id="set-up-docker-registry-cache"><span class="org-todo done DONE">DONE</span> Set up docker registry cache</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd <span style="color:#e6db74">&#34;</span>$NOTES<span style="color:#e6db74">/ws/aws&#34;</span>; ead engine-registry-mirror</code></pre></td></tr></table>
</div>
</div>
<h2 id="complete-example">Complete example</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="color:#a6e22e">concurrent</span> = <span style="color:#ae81ff">50</span>   <span style="color:#75715e"># All registered Runners can run up to 50 concurrent jobs</span>

[[<span style="color:#a6e22e">runners</span>]]
  <span style="color:#a6e22e">url</span> = <span style="color:#e6db74">&#34;https://gitlab.com&#34;</span>
  <span style="color:#a6e22e">token</span> = <span style="color:#e6db74">&#34;RUNNER_TOKEN&#34;</span>             <span style="color:#75715e"># Note this is different from the registration token used by `gitlab-runner register`</span>
  <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;autoscale-runner&#34;</span>
  <span style="color:#a6e22e">executor</span> = <span style="color:#e6db74">&#34;docker+machine&#34;</span>        <span style="color:#75715e"># This Runner is using the &#39;docker+machine&#39; executor</span>
  <span style="color:#a6e22e">limit</span> = <span style="color:#ae81ff">2</span>                          <span style="color:#75715e"># This Runner can execute up to 10 jobs (created machines)</span>
  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">docker</span>]
    <span style="color:#a6e22e">image</span> = <span style="color:#e6db74">&#34;ruby:2.6&#34;</span>               <span style="color:#75715e"># The default image used for jobs is &#39;ruby:2.6&#39;</span>
  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">machine</span>]
    <span style="color:#a6e22e">OffPeakPeriods</span> = [               <span style="color:#75715e"># Set the Off Peak time mode on for:</span>
      <span style="color:#e6db74">&#34;* * 0-8,18-23 * * mon-fri *&#34;</span>, <span style="color:#75715e"># - Monday to Friday from 12:00am through 8:59am and 6:00pm through 11:59pm</span>
      <span style="color:#e6db74">&#34;* * * * * sat,sun *&#34;</span>          <span style="color:#75715e"># - All of Saturday and Sunday</span>
    ]
    <span style="color:#a6e22e">OffPeakTimezone</span> = <span style="color:#e6db74">&#34;Australia/Perth&#34;</span>
    <span style="color:#a6e22e">OffPeakIdleCount</span> = <span style="color:#ae81ff">0</span>             <span style="color:#75715e"># There must be 0 machines in Idle state - when Off Peak time mode is on</span>
    <span style="color:#a6e22e">OffPeakIdleTime</span> = <span style="color:#ae81ff">600</span>            <span style="color:#75715e"># Each machine can be in Idle state up to 10 min (after this it will be removed) - when Off Peak time mode is on</span>
    <span style="color:#a6e22e">IdleCount</span> = <span style="color:#ae81ff">0</span>                    <span style="color:#75715e"># There must be 0 machines in Idle state - when Off Peak time mode is off</span>
    <span style="color:#a6e22e">IdleTime</span> = <span style="color:#ae81ff">600</span>                   <span style="color:#75715e"># Each machine can be in Idle state up to 10 min seconds (after this it will be removed) - when Off Peak time mode is off</span>
    <span style="color:#a6e22e">MaxBuilds</span> = <span style="color:#ae81ff">100</span>                  <span style="color:#75715e"># Each machine can handle up to 100 jobs in a row (after this it will be removed)</span>
    <span style="color:#a6e22e">MachineName</span> = <span style="color:#e6db74">&#34;auto-scale-%s&#34;</span>    <span style="color:#75715e"># Each machine will have a unique name (&#39;%s&#39; is required)</span>
    <span style="color:#a6e22e">MachineDriver</span> = <span style="color:#e6db74">&#34;digitalocean&#34;</span>   <span style="color:#75715e"># Docker Machine is using the &#39;digitalocean&#39; driver</span>
    <span style="color:#a6e22e">MachineOptions</span> = [
        <span style="color:#e6db74">&#34;digitalocean-image=coreos-stable&#34;</span>,
        <span style="color:#e6db74">&#34;digitalocean-ssh-user=core&#34;</span>,
        <span style="color:#e6db74">&#34;digitalocean-access-token=DO_ACCESS_TOKEN&#34;</span>,
        <span style="color:#e6db74">&#34;digitalocean-region=nyc2&#34;</span>,
        <span style="color:#e6db74">&#34;digitalocean-size=4gb&#34;</span>,
        <span style="color:#e6db74">&#34;digitalocean-private-networking&#34;</span>,
        <span style="color:#e6db74">&#34;engine-registry-mirror=http://10.11.12.13:12345&#34;</span>   <span style="color:#75715e"># Docker Machine is using registry mirroring</span>
    ]
  [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">cache</span>]
    <span style="color:#a6e22e">Type</span> = <span style="color:#e6db74">&#34;s3&#34;</span>
    [<span style="color:#a6e22e">runners</span>.<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">s3</span>]
      <span style="color:#a6e22e">ServerAddress</span> = <span style="color:#e6db74">&#34;s3-eu-west-1.amazonaws.com&#34;</span>
      <span style="color:#a6e22e">AccessKey</span> = <span style="color:#e6db74">&#34;AMAZON_S3_ACCESS_KEY&#34;</span>
      <span style="color:#a6e22e">SecretKey</span> = <span style="color:#e6db74">&#34;AMAZON_S3_SECRET_KEY&#34;</span>
      <span style="color:#a6e22e">BucketName</span> = <span style="color:#e6db74">&#34;runner&#34;</span>
      <span style="color:#a6e22e">Insecure</span> = <span style="color:#66d9ef">false</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="here-is-my-autoscale-config">Here is my autoscale config</h2>
<p>$NOTES/ws/aws/autoscale.toml</p>
<h3 id="i-based-it-off-these">I based it off these</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vd $NOTES/ws/aws/<span style="color:#f92672">{</span>example-aws-autoscale.toml,autoscale.toml<span style="color:#f92672">}</span>
vd $NOTES/ws/aws/<span style="color:#f92672">{</span>example-aws-autoscale.toml,example-digitalocean-autoscale.toml<span style="color:#f92672">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="request-more-space-for-testrunner"><span class="org-todo done DONE">DONE</span> Request more space for <code>testrunner</code></h2>
<h2 id="set-up-the-caches-for-gitlab-runner"><span class="org-todo done DONE">DONE</span> Set up the caches for GitLab runner</h2>
<h2 id="set-up-the-manager"><span class="org-todo done DONE">DONE</span> Set up the manager</h2>
<h2 id="set-up-the-mc-command--minio-client"><span class="org-todo done DONE">DONE</span> Set up the <code>mc</code> command (minio client)</h2>
<p><a href="https://docs.min.io/docs/minio-client-quickstart-guide">https://docs.min.io/docs/minio-client-quickstart-guide</a></p>
<p>I will need this to interface with minio.</p>
<h3 id="i-have-to-try-to-configure-a-local-directory-as-a-bucket"><span class="org-todo done DONE">DONE</span> I have to try to configure a local directory as a bucket</h3>
<h4 id="start-by-using-the-gui"><span class="org-todo done DISCARD">DISCARD</span> Start by using the gui</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ff <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>local-forward runnermanager 9005<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="this-creates-a-bucket-called-gitlab-runner-cache">This creates a bucket called <code>gitlab-runner-cache</code></h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager
sudo mkdir -p /export/gitlab-runner-cache</code></pre></td></tr></table>
</div>
</div>
<h3 id="add-the-docker-container-to-mc"><span class="org-todo done DONE">DONE</span> Add the docker container to <code>mc</code></h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager docker pull minio/mc</code></pre></td></tr></table>
</div>
</div>
<h3 id="set-up-a-bucket"><span class="org-todo done DONE">DONE</span> Set up a bucket</h3>
<h2 id="create-the-bucket"><span class="org-todo done DONE">DONE</span> Create the bucket</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh -t runnermanager docker run -it --entrypoint<span style="color:#f92672">=</span>/bin/sh minio/mc</code></pre></td></tr></table>
</div>
</div>
<h3 id="list-buckets">List buckets</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh -t runnermanager docker run -it --entrypoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> minio/mc mc ls</code></pre></td></tr></table>
</div>
</div>
<h3 id="create-a-bucket">Create a bucket</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh -t runnermanager docker run -it --entrypoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> minio/mc mc mb -h</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mc mb /tmp/this/new/dir1</code></pre></td></tr></table>
</div>
</div>
<h2 id="aws"><span class="org-todo done DONE">DONE</span> aws</h2>
<aws get region from instance>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># get the current region at that point in your script</span>
aws configure get region</code></pre></td></tr></table>
</div>
</div>
<h2 id="set-up-the-mc-command--minio-client"><span class="org-todo done DONE">DONE</span> Set up the <code>mc</code> command (minio client)</h2>
<p><a href="https://docs.min.io/docs/minio-client-quickstart-guide">https://docs.min.io/docs/minio-client-quickstart-guide</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">rsync -rtlphx /home/shane/notes/ws/aws/autoscale.toml runnermanager:/home/ubuntu/.gitlab-runner/.gitlab-runner</code></pre></td></tr></table>
</div>
</div>
<h2 id="aws">aws</h2>
<h3 id="do-a-price-analysis-of-options"><span class="org-todo done DONE">DONE</span> Do a price analysis of options</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">egr price analysis ec2</code></pre></td></tr></table>
</div>
</div>
<h3 id="learn-how-to-explore-ec2-costs"><span class="org-todo done DONE">DONE</span> Learn how to explore <code>ec2</code> costs</h3>
<p><a href="https://aws.amazon.com/aws-cost-management/aws-cost-explorer/">https://aws.amazon.com/aws-cost-management/aws-cost-explorer/</a></p>
<h3 id="price-calculator">Price calculator</h3>
<p><a href="https://calculator.aws/#/">https://calculator.aws/#/</a>
<a href="https://aws.amazon.com/ec2/instance-types/">https://aws.amazon.com/ec2/instance-types/</a>
<a href="https://aws.amazon.com/ec2/pricing/on-demand/">https://aws.amazon.com/ec2/pricing/on-demand/</a></p>
<table>
<thead>
<tr>
<th></th>
<th>Dedicated Runner</th>
<th>Runner Manager</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cost</td>
<td>137.68 USD monthly</td>
<td>4.31 + approx. 35.79 USD monthly per spot instance</td>
</tr>
<tr>
<td>Availability</td>
<td>Always running.</td>
<td>Starts new instances on demand.</td>
</tr>
<tr>
<td>Availability zone</td>
<td>Same availability zone as subnet.</td>
<td>Same availability zone as subnet.</td>
</tr>
<tr>
<td>Scaling</td>
<td>1 instance.</td>
<td>Set to scale to 2 instances. May scale to any number of spot instances.</td>
</tr>
<tr>
<td>Docker Caching</td>
<td>Via registry proxy.</td>
<td>Via registry proxy.</td>
</tr>
<tr>
<td>Artifacts</td>
<td>Uploaded to GitLab.</td>
<td>Uploaded to GitLab.</td>
</tr>
<tr>
<td>OffPeak periods</td>
<td>N/A</td>
<td>0-8,18-23 mon-fri</td>
</tr>
</tbody>
</table>
<h4 id="availability">Availability</h4>
<p>Consider using EC2 Autoscaling, which makes
diversification across multiple instance types
and availability zones easier.</p>
<table>
<thead>
<tr>
<th>option</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>amazonec2-subnet-id=subnet-xxxx</td>
<td>The AWS VPC subnet ID.</td>
</tr>
<tr>
<td>amazonec2-zone=x</td>
<td>If not specified, the availability zone is a, it needs to be set to the same availability zone as the specified subnet, for example when the zone is eu-west-1b it has to be amazonec2-zone=b</td>
</tr>
</tbody>
</table>
<!--list-separator-->
<ul>
<li>
<p>Region</p>
<p>Only considering our current AWS region
(<code>Asia-Pacific (Sydney)</code>) when looking at
prices.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Demand</p>
 <!--list-separator-->
<ul>
<li>
<p>Spot instance advisor</p>
<p>Helps you determine pools with the least
chance of interruption and provides the
savings you get over on-demand rates.</p>
<p>You should weigh your application’s tolerance
for interruption and your cost saving goals
when selecting a Spot instance.</p>
<p>The lower your interruption rate, the longer
your Spot instances are likely to run.</p>
<p><a href="https://aws.amazon.com/ec2/spot/instance-advisor/">https://aws.amazon.com/ec2/spot/instance-advisor/</a></p>
</li>
</ul>
</li>
</ul>
<h4 id="machine-types">Machine types</h4>
<table>
<thead>
<tr>
<th>Instance Size</th>
<th>vCPU</th>
<th>Memory (GiB)</th>
<th>Instance Storage (GiB)</th>
<th>Network Bandwidth (Gbps)</th>
<th>EBS Bandwidth (Mbps)</th>
</tr>
</thead>
<tbody>
<tr>
<td>m5.2xlarge</td>
<td>8</td>
<td>32</td>
<td>EBS-Only</td>
<td>Up to 10</td>
<td>Up to 4,750</td>
</tr>
</tbody>
</table>
<h4 id="dedicated-runner">Dedicated Runner</h4>
<!--list-separator-->
<ul>
<li>Cost
<table>
<thead>
<tr>
<th>machine</th>
<th>cost per hour</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS <code>m5.2xlarge</code></td>
<td></td>
<td>1</td>
</tr>
</tbody>
</table>
</li>
</ul>
<!--list-separator-->
<ul>
<li>Availability</li>
</ul>
<!--list-separator-->
<ul>
<li>Scaling</li>
</ul>
<!--list-separator-->
<ul>
<li>Docker Caching</li>
</ul>
<!--list-separator-->
<ul>
<li>Artifacts</li>
</ul>
<h4 id="runner-manager">Runner Manager</h4>
<table>
<thead>
<tr>
<th>instance type</th>
<th>vCPU</th>
<th>Mem (GiB)</th>
</tr>
</thead>
<tbody>
<tr>
<td>t3.micro</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>m5.2xlarge</td>
<td>8</td>
<td>32</td>
</tr>
</tbody>
</table>
<!--list-separator-->
<ul>
<li>Cost
<table>
<thead>
<tr>
<th>machine</th>
<th>cost per month / instance</th>
<th>max quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS <code>t3.micro</code></td>
<td>4.31 USD</td>
<td>1</td>
</tr>
<tr>
<td>Spot AWS <code>m5.2xlarge</code></td>
<td>35.79 USD</td>
<td>2</td>
</tr>
</tbody>
</table>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Spot instances</p>
<p><a href="https://aws.amazon.com/ec2/spot/instance-advisor/">https://aws.amazon.com/ec2/spot/instance-advisor/</a>
Savings over on-demand: 74%
Frequency of interruption: 15-20%</p>
<p>35.79 USD monthly / spot instance</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>Availability</li>
</ul>
<!--list-separator-->
<ul>
<li>Scaling</li>
</ul>
<!--list-separator-->
<ul>
<li>Docker Caching</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Artifacts</p>
<p><a href="https://docs.gitlab.com/ee/administration/job%5Fartifacts.html">https://docs.gitlab.com/ee/administration/job%5Fartifacts.html</a></p>
</li>
</ul>
<h3 id="tramp">Tramp</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sp /ssh:runnermanager:/home/ubuntu</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sp /ssh:runnermanager:/home/ubuntu/.gitlab-runner/config.toml</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">eshell cd /ssh:runnermanager:/home/ubuntu/.gitlab-runner/</code></pre></td></tr></table>
</div>
</div>
<h3 id="tweaked-some-parameters"><span class="timestamp-wrapper"><span class="timestamp">&lt;2020-05-01 Fri&gt; </span></span> Tweaked some parameters</h3>
<ul>
<li>Increased the job concurrency</li>
<li>Increased the job request concurrency</li>
</ul>
<h3 id="register-runnermanager">Register runnermanager</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo gitlab-runner register <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --non-interactive <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -u $CI_SERVER_URL <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -r $REGISTRATION_TOKEN <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --tag-list $DOCKER_MACHINE_RUNNER_TAG_LIST <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --executor $DOCKER_MACHINE_RUNNER_EXECUTOR <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --name $DOCKER_MACHINE_RUNNER_NAME <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --locked<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --docker-tlsverify<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --docker-image<span style="color:#f92672">=</span>alpine <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-driver <span style="color:#e6db74">&#34;amazonec2&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-name <span style="color:#e6db74">&#34;gitlab-docker-machine-%s&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-iam-instance-profile=***&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-region=us-west-2&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-vpc-id=***&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-subnet-id=***&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-instance-type=t2.medium&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;engine-storage-driver=overlay&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-use-private-address=true&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-tags=runner-manager-name,gitlab-aws-autoscaler,gitlab,true,gitlab-runner-autoscale,true&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-zone=b&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-request-spot-instance=true&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-machine-options <span style="color:#e6db74">&#34;amazonec2-spot-price=0.05&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-idle-nodes <span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --machine-max-builds <span style="color:#e6db74">&#34;100&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --request-concurrency <span style="color:#e6db74">&#34;10&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --output-limit <span style="color:#ae81ff">16384</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --docker-privileged <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cache-type <span style="color:#e6db74">&#34;s3&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cache-s3-server-address <span style="color:#e6db74">&#34;s3.amazonaws.com&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cache-s3-bucket-name <span style="color:#e6db74">&#34;***-gitlab-runner-cache&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cache-s3-bucket-location <span style="color:#e6db74">&#34;us-west-2&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cache-cache-shared<span style="color:#f92672">=</span>true</code></pre></td></tr></table>
</div>
</div>
<h2 id="set-up-docker-machine-for-runnermanager"><span class="org-todo done DONE">DONE</span> Set up <code>docker-machine</code> for <code>runnermanager</code></h2>
<h3 id="manually-spawn-some-containers">Manually spawn some containers</h3>
<p>This way I can be sure that the autospawn works.</p>
<h2 id="ensure-i-can-manage-the-docker-machines-which-are-spawned-by-gitlab-runner"><span class="org-todo done DONE">DONE</span> Ensure I can manage the docker-machines which are spawned by gitlab-runner</h2>
<h2 id="ensure-i-can-start-the-runner-by-increasing-the-spot-price"><span class="org-todo done DONE">DONE</span> Ensure I can start the runner by increasing the spot price</h2>
<p><a href="https://ap-southeast-2.console.aws.amazon.com/ec2sp/v1/spot/home?region=ap-southeast-2">https://ap-southeast-2.console.aws.amazon.com/ec2sp/v1/spot/home?region=ap-southeast-2</a>#</p>
<h2 id="spot-instance-aws">Spot instance aws</h2>
<p>Running CI jobs on Spot instances may increase
the failure rates because of the Spot
instances pricing model. If the maximum Spot
price you specify exceeds the current Spot
price you will not get the capacity requested.
Spot pricing is revised on an hourly basis.
Any existing Spot instances that have a
maximum price below the revised Spot instance
price will be terminated within two minutes
and all jobs on Spot hosts will fail.</p>
<p>As a consequence, the auto-scale Runner would
fail to create new machines while it will
continue to request new instances. This
eventually will make 60 requests and then AWS
won’t accept any more. Then once the Spot
price is acceptable, you are locked out for a
bit because the call amount limit is exceeded.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh runnermanager <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cmd docker-machine ls -q --filter state<span style="color:#f92672">=</span>Error --format <span style="color:#e6db74">&#34;{{.NAME}}&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>The sydney region appears to only have
capacity to fulfill requests for <code>c5.large</code> at
0.061 USD per hour.</p>
<table>
<thead>
<tr>
<th>type</th>
<th>provisioned</th>
<th>price</th>
</tr>
</thead>
<tbody>
<tr>
<td>t2.large</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>t2.xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>t2.2xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>t5.large</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>t5.xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>t5.2xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>c5.large</td>
<td>success</td>
<td>0.061</td>
</tr>
<tr>
<td>c5.xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>c5.2xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>m5.large</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>m5.xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
<tr>
<td>m5.2xlarge</td>
<td>no capacity</td>
<td></td>
</tr>
</tbody>
</table>
<p>I set to a max of 0.07 spot price bid.</p>
<h2 id="set-up-spot-fleet"><span class="org-todo done DONE">DONE</span> Set up Spot fleet</h2>
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-fleet.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-fleet.html</a></p>
<p>This is the answer to capacity problems.</p>
<h2 id="set-up-the-caching-docker-registry">Set up the caching docker registry</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sshv runnermanager docker run --rm --name docker_registry_proxy -it <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       -p 0.0.0.0:3128:3128 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --restart always <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       -v /export/docker-cache:/docker_mirror_cache <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       -v /docker-mirror-certs:/ca <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       -e REGISTRIES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;registry.apex.ai registry.gitlab.com&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       -e AUTH_REGISTRIES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;auth.docker.io:dockerhub_username:dockerhub_password&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       rpardini/docker-registry-proxy:0.3.0</code></pre></td></tr></table>
</div>
</div>
<h2 id="check-to-see-which-docker-images-have-been-cached">Check to see which docker images have been cached</h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh -t runnermanager <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cmd curl <span style="color:#e6db74">&#34;http://localhost:6000/v2/_catalog&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> | pavs</code></pre></td></tr></table>
</div>
</div>
<h2 id="using-the-cache-for-incremental-building">Using the cache for incremental building</h2>
<p><a href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/56458">https://gitlab.com/gitlab-org/gitlab-foss/-/issues/56458</a></p>
<p>It should be noted that only a successful build will save to the cache.</p>
<p>Also, a failed job does not clear the cache.</p>

    </div>
    <div class="post-footer">
        <p>
        <a href="https://mullikine.github.io/">Latest articles</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/about/">About this weblog</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://asciinema.org/~mullikine">Asciinema recordings</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/posts/blogs-and-vlogs/">Blogs and Vlogs</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/tags/">Site Map</a>
        </p>
    </div>
  </article>

    </main>
  </body>
</html>
