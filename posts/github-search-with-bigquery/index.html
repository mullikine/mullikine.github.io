<!doctype html>
<html lang="en-us">
  <head>
    <title>Tremendous Task: Searching for code on GitHub with BigQuery and GHTorrent // Bodacious Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.59.0-DEV" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://mullikine.github.io/css/main.min.137fbfb47945557f8242a34980e94d64c98087dcc138904127a1c9808cff1b2c.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tremendous Task: Searching for code on GitHub with BigQuery and GHTorrent"/>
<meta name="twitter:description" content="Searching GitHub for regular expression matches in code is a tremendous task.
Prerequisites Set up the bq command https://cloud.google.com/bigquery/docs/bq-command-line-tool
Lots of money Sample search About US$5 per search.
This is cheaper than searching all files.
   shell variable function     $query a regular expression that searches the contents of files   $path_re a regex that matches on the file path   $path_re_exclude a regex that matches on the file path for pruning results    #standardSQL SELECT sample_repo_name, sample_path, (SELECT STRING_AGG(snip) FROM snippets."/>

    <meta property="og:title" content="Tremendous Task: Searching for code on GitHub with BigQuery and GHTorrent" />
<meta property="og:description" content="Searching GitHub for regular expression matches in code is a tremendous task.
Prerequisites Set up the bq command https://cloud.google.com/bigquery/docs/bq-command-line-tool
Lots of money Sample search About US$5 per search.
This is cheaper than searching all files.
   shell variable function     $query a regular expression that searches the contents of files   $path_re a regex that matches on the file path   $path_re_exclude a regex that matches on the file path for pruning results    #standardSQL SELECT sample_repo_name, sample_path, (SELECT STRING_AGG(snip) FROM snippets." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mullikine.github.io/posts/github-search-with-bigquery/" />
<meta property="article:published_time" content="2019-10-04T00:00:00+13:00" />
<meta property="article:modified_time" content="2019-10-04T00:00:00+13:00" /><meta property="og:site_name" content="Bodacious Blog" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://mullikine.github.io"><img class="app-header-avatar" src="http://mullikine.github.io/fievel.png" alt="John Doe" /></a>
      <h1>Bodacious Blog</h1>
      
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://linkedin.com/in/shane-mulligan-811b942b/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
        
          <a target="_blank" href="https://gitlab.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-gitlab">
  <title>gitlab</title>
  <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
        <a href="https://mullikine.github.io/cv/">CV</a>
      </div>
<div class="highlights">
<a href="https://mullikine.github.io/posts/practical-macros-in-racket-and-how-to-work-with-them/">Practical macros in Racket</a>
<br />
<a href="https://mullikine.github.io/posts/github-search-with-bigquery/">Searching GitHub with BigQuery</a>

<br />
<a href="https://mullikine.github.io/posts/arbitrary-interpreters-for-babel/">Arbitrary interpreters for Babel</a>
<br />
<a href="https://mullikine.github.io/posts/review-of-the-illustrated-transformer/">The Illustrated Transformer</a>
<br />
<a href="https://mullikine.github.io/glossary.html">Glossary A-Z (70 topics)</a>
<br />
<a href="https://mullikine.github.io/codelingo-vs-linters/main/">CodeLingo vs Linters</a>
<br />
<div class="taglist">

<a class="tag" href="https://mullikine.github.io/tags/gpt-2/">GPT-2</a>
<a class="tag" href="https://mullikine.github.io/tags/nlp/">NLP</a>
<a class="tag" href="https://mullikine.github.io/tags/emacs/">emacs</a>
<a class="tag" href="https://mullikine.github.io/tags/elisp/">elisp</a>
<a class="tag" href="https://mullikine.github.io/tags/racket/">racket</a>
<a class="tag" href="https://mullikine.github.io/tags/haskell/">haskell</a>
<a class="tag" href="https://mullikine.github.io/tags/biosemiotics/">biosemiotics</a>
<a class="tag" href="https://mullikine.github.io/tags/ir/">IR</a>
<a class="tag" href="https://mullikine.github.io/tags/games/">games</a>
<a class="tag" href="https://mullikine.github.io/tags/info/">information theory</a>
<a class="tag" href="https://mullikine.github.io/tags/probability/">probability</a>
<a class="tag" href="https://mullikine.github.io/tags/bash/">bash</a>
<a class="tag" href="https://mullikine.github.io/tags/gcp/">GCP</a>
<a class="tag" href="https://mullikine.github.io/tags/github/">github</a>
<a class="tag" href="https://mullikine.github.io/tags/parsers/">parsers</a>
<a class="tag" href="https://mullikine.github.io/tags/rust/">rust</a>
<a class="tag" href="https://mullikine.github.io/tags/cpp/">c++</a>
<a class="tag" href="https://mullikine.github.io/tags/transformer/">transformer</a>
<a class="tag" href="https://mullikine.github.io/tags/kaggle/">kaggle</a>
<a class="tag" href="https://mullikine.github.io/tags/dl/">deep learning</a>
<a class="tag" href="https://mullikine.github.io/tags/dsls/">DSLs</a>
<a class="tag" href="https://mullikine.github.io/tags/df/">dwarf fortress</a>
<a class="tag" href="https://mullikine.github.io/tags/spacy/">spacy</a>
<a class="tag" href="https://mullikine.github.io/tags/latex/">latex</a>
<a class="tag" href="https://mullikine.github.io/tags/graphviz/">graphviz</a>
<a class="tag" href="https://mullikine.github.io/tags/python/">python</a>
<a class="tag" href="https://mullikine.github.io/tags/golang/">golang</a>
<a class="tag" href="https://mullikine.github.io/tags/codelingo/">codelingo</a>
<a class="tag" href="https://mullikine.github.io/tags/review/">review</a>
</div>
<div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Tremendous Task: Searching for code on GitHub with BigQuery and GHTorrent</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Oct 4, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://mullikine.github.io/tags/ir/">IR</a><a class="tag" href="http://mullikine.github.io/tags/github/">github</a><a class="tag" href="http://mullikine.github.io/tags/sql/">sql</a><a class="tag" href="http://mullikine.github.io/tags/gcp/">GCP</a></div></div>
    </header>
    

<link rel="stylesheet" type="text/css" href="https://mullikine.github.io/css/magit.css"/>

<script src="https://mullikine.github.io/js/mathjax-config.js"></script>
 
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>


    <div class="post-content">
      

<p>Searching <code>GitHub</code> for regular expression matches in code is a <em>tremendous task</em>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<h3 id="set-up-the-bq-command">Set up the <code>bq</code> command</h3>

<p><a href="https://cloud.google.com/bigquery/docs/bq-command-line-tool">https://cloud.google.com/bigquery/docs/bq-command-line-tool</a></p>

<h3 id="lots-of-money">Lots of money</h3>

<h2 id="sample-search">Sample search</h2>

<p>About <code>US$5</code> per search.</p>

<p>This is cheaper than searching all files.</p>

<table>
<thead>
<tr>
<th>shell variable</th>
<th>function</th>
</tr>
</thead>

<tbody>
<tr>
<td>$query</td>
<td>a regular expression that searches the contents of files</td>
</tr>

<tr>
<td>$path_re</td>
<td>a regex that matches on the file path</td>
</tr>

<tr>
<td>$path_re_exclude</td>
<td>a regex that matches on the file path for pruning results</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span>standardSQL
<span style="color:#66d9ef">SELECT</span>
  sample_repo_name,
  sample_path,
  (<span style="color:#66d9ef">SELECT</span> STRING_AGG(snip) <span style="color:#66d9ef">FROM</span> snippets.snip) <span style="color:#66d9ef">AS</span> snippets
<span style="color:#66d9ef">FROM</span> (
  <span style="color:#66d9ef">SELECT</span>
    sample_repo_name, sample_path, REGEXP_EXTRACT_ALL(content, r<span style="color:#e6db74">&#39;.*$query.*&#39;</span>) <span style="color:#66d9ef">AS</span> snip
  <span style="color:#66d9ef">FROM</span> (
    <span style="color:#66d9ef">SELECT</span> sample_repo_name, content, sample_path <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>bigquery<span style="color:#f92672">-</span><span style="color:#66d9ef">public</span><span style="color:#f92672">-</span><span style="color:#66d9ef">data</span>.github_repos.sample_contents<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>
        <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">TRUE</span>
        <span style="color:#960050;background-color:#1e0010">$</span>(
        <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$query&#34;</span> ]; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;AND REGEXP_CONTAINS(content, r&#39;$query&#39;)&#34;</span>
        fi

        <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$path_re&#34;</span> ]; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;AND REGEXP_CONTAINS(sample_path, r&#39;$path_re&#39;)&#34;</span>
        fi

        <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$exclude_path_re&#34;</span> ]; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;AND NOT REGEXP_CONTAINS(sample_path, r&#39;$exclude_path_re&#39;)&#34;</span>
        fi
        )
  )
) snippets <span style="color:#66d9ef">LIMIT</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">limit</span></code></pre></div>
<h2 id="full-contents-search-search-all-files">Full contents search &ndash; Search all files</h2>

<p>About <code>US$20</code> per search.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span>standardSQL
<span style="color:#66d9ef">SELECT</span>
  repo_name,
  path,
  (<span style="color:#66d9ef">SELECT</span> STRING_AGG(snip) <span style="color:#66d9ef">FROM</span> snippets.snip) <span style="color:#66d9ef">AS</span> snippets
<span style="color:#66d9ef">FROM</span> (
  <span style="color:#66d9ef">SELECT</span>
    files.repo_name, files.path,
        <span style="color:#960050;background-color:#1e0010">$</span>(
        <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$query&#34;</span> ]; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;REGEXP_EXTRACT_ALL(contents.content, r&#39;.*$query.*&#39;) AS snip&#34;</span>
        <span style="color:#66d9ef">else</span>
            lit <span style="color:#e6db74">&#34;\&#34;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#e6db74">&#34; AS snip&#34;</span>
        fi
        )
  <span style="color:#66d9ef">FROM</span> (
    <span style="color:#f92672">#</span> test the file <span style="color:#66d9ef">size</span> <span style="color:#66d9ef">in</span> tiny (snippet <span style="color:#66d9ef">size</span>)
    <span style="color:#66d9ef">SELECT</span> id, <span style="color:#66d9ef">size</span>, content, binary <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>bigquery<span style="color:#f92672">-</span><span style="color:#66d9ef">public</span><span style="color:#f92672">-</span><span style="color:#66d9ef">data</span>.github_repos.contents<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>
        <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">TRUE</span>
        <span style="color:#66d9ef">AND</span> binary <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
        <span style="color:#66d9ef">AND</span> <span style="color:#66d9ef">size</span> <span style="color:#f92672">&lt;</span> <span style="color:#960050;background-color:#1e0010">$</span>MAX_FILE_SIZE
        <span style="color:#960050;background-color:#1e0010">$</span>(
        <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$query&#34;</span> ]; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;AND REGEXP_CONTAINS(content, r&#39;$query&#39;)&#34;</span>
        fi
        )
  ) <span style="color:#66d9ef">as</span> contents
  <span style="color:#66d9ef">JOIN</span>
  (
    <span style="color:#66d9ef">SELECT</span> repo_name, id, path <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>bigquery<span style="color:#f92672">-</span><span style="color:#66d9ef">public</span><span style="color:#f92672">-</span><span style="color:#66d9ef">data</span>.github_repos.files<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>
        <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">TRUE</span>
        <span style="color:#960050;background-color:#1e0010">$</span>(
        <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$path_re&#34;</span> ]; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;AND REGEXP_CONTAINS(path, r&#39;$path_re&#39;)&#34;</span>
        fi

        <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$exclude_path_re&#34;</span> ]; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;AND NOT REGEXP_CONTAINS(path, r&#39;$exclude_path_re&#39;)&#34;</span>
        fi
    )
  ) <span style="color:#66d9ef">as</span> files
  <span style="color:#66d9ef">ON</span> contents.id <span style="color:#f92672">=</span> files.id
) snippets <span style="color:#66d9ef">LIMIT</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">limit</span></code></pre></div>
<h2 id="using-ghtorrent">Using GHTorrent</h2>

<p>Using <code>GHTorrent</code> we can sort repositories according to the number of stars.</p>

<p>We can also reduce the amount of repositories searched with regex by limiting our search to repositories of a specific language.</p>

<p>This will make the results cheaper and more relevant.</p>

<table>
<thead>
<tr>
<th>shell variable</th>
<th>function</th>
</tr>
</thead>

<tbody>
<tr>
<td>$language</td>
<td>specifying the language</td>
</tr>
</tbody>
</table>

<h3 id="join-two-big-query-tables-with-standardsql">Join two big query tables with <code>#standardSQL</code></h3>

<p>We will do something like this but for <code>ghtorrent</code> and <code>bigquery-public-data.github_repos</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">sum</span>(a.is_male)
<span style="color:#66d9ef">from</span>
(<span style="color:#66d9ef">select</span> is_male, <span style="color:#66d9ef">year</span> <span style="color:#66d9ef">from</span> publicdata.samples.natality) a
<span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span>
(<span style="color:#66d9ef">select</span> <span style="color:#66d9ef">year</span> <span style="color:#66d9ef">from</span> moshap.my_years) b
<span style="color:#66d9ef">on</span> a.<span style="color:#66d9ef">year</span> <span style="color:#f92672">=</span> b.<span style="color:#66d9ef">year</span></code></pre></div>
<h3 id="results">Results</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span>standardSQL
<span style="color:#66d9ef">SELECT</span>
  contents_search_results.repo_name,
  contents_search_results.path,
  contents_search_results.final_snippets,
  contents_search_results.repo_id,
  contents_search_results.forked_from,
  ranking_info.stars
<span style="color:#66d9ef">FROM</span>
(
    <span style="color:#66d9ef">SELECT</span>
      final_contents_table.repo_name,
      final_contents_table.path,
      final_contents_table.final_snippets,
      final_contents_table.repo_id,
      final_contents_table.forked_from
    <span style="color:#66d9ef">FROM</span>
    (
      <span style="color:#66d9ef">SELECT</span>
        ght.id <span style="color:#66d9ef">as</span> repo_id,
        pd.repo_name <span style="color:#66d9ef">as</span> repo_name,
        pd.path <span style="color:#66d9ef">as</span> path,
        pd.bqsnippets <span style="color:#66d9ef">as</span> final_snippets,
        ght.forked_from <span style="color:#66d9ef">as</span> forked_from
      <span style="color:#66d9ef">FROM</span>
      (
      <span style="color:#66d9ef">SELECT</span> id, REGEXP_EXTRACT(url, r<span style="color:#e6db74">&#34;[^/]+/[^/]+$&#34;</span>) <span style="color:#66d9ef">as</span> repo_name, forked_from <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>ghtorrent<span style="color:#f92672">-</span>bq.ght_2018_04_01.projects<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">$</span>(<span style="color:#66d9ef">if</span> test <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$language&#34;</span>; <span style="color:#66d9ef">then</span> echo <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;language = \&#34;</span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">language</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#e6db74">&#34; AND&#34;</span>; fi) forked_from <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span>
      ) ght
      <span style="color:#66d9ef">JOIN</span>
      (
        <span style="color:#66d9ef">SELECT</span>
          repo_name,
          path,
          (<span style="color:#66d9ef">SELECT</span> STRING_AGG(snip) <span style="color:#66d9ef">FROM</span> snippets.snip) <span style="color:#66d9ef">AS</span> bqsnippets
        <span style="color:#66d9ef">FROM</span> (
          <span style="color:#66d9ef">SELECT</span>
            files.repo_name, files.path,
                <span style="color:#960050;background-color:#1e0010">$</span>(
                <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$query&#34;</span> ]; <span style="color:#66d9ef">then</span>
                    lit <span style="color:#e6db74">&#34;REGEXP_EXTRACT_ALL(contents.content, r&#39;.*$query.*&#39;) AS snip&#34;</span>
                <span style="color:#66d9ef">else</span>
                    lit <span style="color:#e6db74">&#34;\&#34;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#e6db74">&#34; AS snip&#34;</span>
                fi
                )
          <span style="color:#66d9ef">FROM</span> (
            <span style="color:#f92672">#</span> test the file <span style="color:#66d9ef">size</span> <span style="color:#66d9ef">in</span> tiny (snippet <span style="color:#66d9ef">size</span>)
            <span style="color:#66d9ef">SELECT</span> id, <span style="color:#66d9ef">size</span>, content, binary <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>bigquery<span style="color:#f92672">-</span><span style="color:#66d9ef">public</span><span style="color:#f92672">-</span><span style="color:#66d9ef">data</span>.github_repos.contents<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>
                <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">TRUE</span>
                <span style="color:#66d9ef">AND</span> binary <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
                <span style="color:#66d9ef">AND</span> <span style="color:#66d9ef">size</span> <span style="color:#f92672">&lt;</span> <span style="color:#960050;background-color:#1e0010">$</span>MAX_FILE_SIZE
                <span style="color:#960050;background-color:#1e0010">$</span>(
                <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$query&#34;</span> ]; <span style="color:#66d9ef">then</span>
                    lit <span style="color:#e6db74">&#34;AND REGEXP_CONTAINS(content, r&#39;$query&#39;)&#34;</span>
                fi
                )
          ) <span style="color:#66d9ef">as</span> contents
          <span style="color:#66d9ef">JOIN</span>
          (
            <span style="color:#66d9ef">SELECT</span> repo_name, id, path <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>bigquery<span style="color:#f92672">-</span><span style="color:#66d9ef">public</span><span style="color:#f92672">-</span><span style="color:#66d9ef">data</span>.github_repos.files<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>
                <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">TRUE</span>
                <span style="color:#960050;background-color:#1e0010">$</span>(
                <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$path_re&#34;</span> ]; <span style="color:#66d9ef">then</span>
                    lit <span style="color:#e6db74">&#34;AND REGEXP_CONTAINS(path, r&#39;$path_re&#39;)&#34;</span>
                fi
                )

                <span style="color:#960050;background-color:#1e0010">$</span>(
                <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>n <span style="color:#e6db74">&#34;$exclude_path_re&#34;</span> ]; <span style="color:#66d9ef">then</span>
                    lit <span style="color:#e6db74">&#34;AND NOT REGEXP_CONTAINS(path, r&#39;$exclude_path_re&#39;)&#34;</span>
                fi
                )
          ) <span style="color:#66d9ef">as</span> files
          <span style="color:#66d9ef">ON</span> contents.id <span style="color:#f92672">=</span> files.id
        ) snippets
      ) pd
      <span style="color:#66d9ef">ON</span> pd.repo_name <span style="color:#f92672">=</span> ght.repo_name
    ) final_contents_table
) contents_search_results
<span style="color:#66d9ef">JOIN</span>
(
  <span style="color:#66d9ef">SELECT</span> repo_id, <span style="color:#66d9ef">COUNT</span>(<span style="color:#66d9ef">DISTINCT</span> user_id) <span style="color:#66d9ef">as</span> stars <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>ghtorrent<span style="color:#f92672">-</span>bq.ght_2018_04_01.watchers<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">`</span>
      <span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> repo_id
) ranking_info
<span style="color:#66d9ef">ON</span> contents_search_results.repo_id <span style="color:#f92672">=</span> ranking_info.repo_id
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> stars <span style="color:#66d9ef">DESC</span>
<span style="color:#66d9ef">LIMIT</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">limit</span></code></pre></div>
<h2 id="generate-the-org-mode-document-with-all-results">Generate the <code>org-mode</code> document with all results</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">lit <span style="color:#e6db74">&#34;* query&#34;</span>
lit <span style="color:#e6db74">&#34;#+BEGIN_SRC sql&#34;</span>
lit <span style="color:#e6db74">&#34;</span>$sql<span style="color:#e6db74">&#34;</span> | indent <span style="color:#ae81ff">2</span>
lit <span style="color:#e6db74">&#34;#+END_SRC&#34;</span>
lit
lit <span style="color:#e6db74">&#34;* results&#34;</span>
lit <span style="color:#e6db74">&#34;</span>$sql<span style="color:#e6db74">&#34;</span> | ds -q gh-query-sql | tee /tmp/wizard-last-query.txt | ci bq -q --format<span style="color:#f92672">=</span>csv query --max_rows<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span> | ds -q bq-query | <span style="color:#f92672">{</span>
    count2<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    awk <span style="color:#ae81ff">1</span> | sed <span style="color:#ae81ff">1</span>,2d | <span style="color:#66d9ef">while</span> IFS<span style="color:#f92672">=</span><span style="color:#e6db74">$&#39;\n&#39;</span> read -r line; <span style="color:#66d9ef">do</span>
        repo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>lit <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> | awk -F, <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>lit <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> | awk -F, <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        stars<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>lit <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> | awk -F, <span style="color:#e6db74">&#39;{print $6}&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        snips<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>lit <span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span> | sed <span style="color:#e6db74">&#39;s/^[^,]\+,[^,]\+,//&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

        link<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/</span>$repo<span style="color:#e6db74">/blob/master/</span><span style="color:#e6db74">${</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">#L2-L10&#34;</span>
        rawlink<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://raw.githubusercontent.com/</span>$repo<span style="color:#e6db74">/master/</span>$path<span style="color:#e6db74">&#34;</span>

        <span style="color:#66d9ef">if</span> url-exists.js <span style="color:#e6db74">&#34;</span>$rawlink<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
            <span style="color:#75715e"># td_tempdir=&#34;$(mktemp -t -d td_tempdirXXXXXX || echo /dev/null)&#34;</span>
            td_tempdir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$NOTES<span style="color:#e6db74">/programs/gh-query/</span>$slug<span style="color:#e6db74">&#34;</span>
            mkdir -p <span style="color:#e6db74">&#34;</span>$td_tempdir<span style="color:#e6db74">&#34;</span>
            wget -P <span style="color:#e6db74">&#34;</span>$td_tempdir<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$rawlink<span style="color:#e6db74">&#34;</span> &amp;&gt;/dev/null
            fpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>wfind <span style="color:#e6db74">&#34;</span>$td_tempdir<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        <span style="color:#66d9ef">fi</span>

        bn<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>basename <span style="color:#e6db74">&#34;</span>$path<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        lit <span style="color:#e6db74">&#34;** </span><span style="color:#e6db74">${</span>count2<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span>$repo<span style="color:#e6db74">&#34;</span>
        lit <span style="color:#e6db74">&#34;|stars&#34;</span>
        lit <span style="color:#e6db74">&#34;|-&#34;</span>
        lit <span style="color:#e6db74">&#34;|</span>$stars<span style="color:#e6db74">&#34;</span>

        <span style="color:#75715e"># lit &#34;+ line : $line&#34;</span>
        lit <span style="color:#e6db74">&#34;+ link :: </span><span style="color:#66d9ef">$(</span>printf -- <span style="color:#e6db74">&#34;%s\n&#34;</span> <span style="color:#e6db74">&#34;</span>$link<span style="color:#e6db74">&#34;</span> | get_link<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        lit <span style="color:#e6db74">&#34;+ raw :: [[</span>$rawlink<span style="color:#e6db74">][</span>$bn<span style="color:#e6db74">]]&#34;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$fpath<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
            lit <span style="color:#e6db74">&#34;+ local :: [[</span>$fpath<span style="color:#e6db74">][</span>$fpath<span style="color:#e6db74">]]&#34;</span>
        <span style="color:#66d9ef">fi</span>
        lit <span style="color:#e6db74">&#34;#+BEGIN_SRC text&#34;</span>
        lit <span style="color:#e6db74">&#34;</span>$snips<span style="color:#e6db74">&#34;</span> | format_snippet
        lit <span style="color:#e6db74">&#34;#+END_SRC&#34;</span>
        lit

        count2<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span> $count2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">))</span>
    <span style="color:#66d9ef">done</span>
<span style="color:#f92672">}</span> | ds -q gh-query</code></pre></div>
<h2 id="annex">Annex</h2>

<h3 id="tables-used">Tables used</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">bq show bigquery-public-data:github_repos.contents
bq show bigquery-public-data:samples.wikipedia
bq show --format<span style="color:#f92672">=</span>prettyjson bigquery-public-data:samples.wikipedia | jq <span style="color:#e6db74">&#39;.schema.fields&#39;</span></code></pre></div>
<h3 id="download-the-schema">Download the schema</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">bq show --format json bigquery-public-data:samples.wikipedia
bq show --format json bigquery-public-data:github_repos.sample_contents | python -m json.tool
bq show --format<span style="color:#f92672">=</span>prettyjson bigquery-public-data:samples.wikipedia | jq <span style="color:#e6db74">&#39;.schema.fields&#39;</span>
bq show --format<span style="color:#f92672">=</span>prettyjson bigquery-public-data:github_repos.sample_contents | jq <span style="color:#e6db74">&#39;.schema.fields&#39;</span>
bq show --schema --format<span style="color:#f92672">=</span>prettyjson bigquery-public-data:github_repos.sample_contents</code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>