<!doctype html>
<html lang="en-us">
  <head>
    <title>Curling the paged GitHub API // Bodacious Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.59.0-DEV" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://mullikine.github.io/css/main.min.fb222e05f6f82c63ca9f2a61b40175e4c15df390babdb6f59982bd612383422c.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Curling the paged GitHub API"/>
<meta name="twitter:description" content="The GitHub API The GitHub API is useful for many things including running searches on issues, repositories and contributors.
It makes use of pagination and rate limiting.
We like the convenience of curl on the command line and don&rsquo;t wish to learn another tool.
Therefore we make a wrapper script around curl to take care of authentication and pagination.
 Tools used to build the gh-curl script:  jq yq curl grep   The gh-curl script #!"/>

    <meta property="og:title" content="Curling the paged GitHub API" />
<meta property="og:description" content="The GitHub API The GitHub API is useful for many things including running searches on issues, repositories and contributors.
It makes use of pagination and rate limiting.
We like the convenience of curl on the command line and don&rsquo;t wish to learn another tool.
Therefore we make a wrapper script around curl to take care of authentication and pagination.
 Tools used to build the gh-curl script:  jq yq curl grep   The gh-curl script #!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mullikine.github.io/posts/curling-the-paged-github-api/" />
<meta property="article:published_time" content="2019-09-19T00:00:00+12:00" />
<meta property="article:modified_time" content="2019-09-19T00:00:00+12:00" /><meta property="og:site_name" content="Bodacious Blog" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://mullikine.github.io"><img class="app-header-avatar" src="http://mullikine.github.io/avatar.gif" alt="John Doe" /></a>
      <h1>Bodacious Blog</h1>
      <p>Talk about biosemiotics and xenolingustics is welcome here</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Curling the paged GitHub API</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Sep 19, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          2 min read
        </div></div>
    </header>
    <div class="post-content">
      

<h2 id="the-github-api">The GitHub API</h2>

<p>The GitHub API is useful for many things including running searches on issues, repositories and contributors.</p>

<p>It makes use of pagination and rate limiting.</p>

<p>We like the convenience of curl on the command line and don&rsquo;t wish to learn another tool.</p>

<p>Therefore we make a wrapper script around curl to take care of authentication and pagination.</p>

<ul>
<li>Tools used to build the <code>gh-curl</code> script:

<ul>
<li>jq</li>
<li>yq</li>
<li>curl</li>
<li>grep</li>
</ul></li>
</ul>

<h2 id="the-gh-curl-script">The <code>gh-curl</code> script</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>export TTY

enumerate<span style="color:#f92672">=</span>
NO_REDIRECT<span style="color:#f92672">=</span>
N_PAGES<span style="color:#f92672">=</span>
: <span style="color:#e6db74">${</span>AS_USER:=<span style="color:#e6db74">&#34;me&#34;</span><span style="color:#e6db74">}</span>
<span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> $# -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">do</span> opt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span>$opt<span style="color:#e6db74">&#34;</span> in
<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> shift; <span style="color:#f92672">}</span>; ;;

-me<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    AS_USER<span style="color:#f92672">=</span>me
    shift
<span style="color:#f92672">}</span>
;;

-all|-enum|-enumerate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    enumerate<span style="color:#f92672">=</span>y
    shift
<span style="color:#f92672">}</span>
;;

-nr|-no-redirect<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    NO_REDIRECT<span style="color:#f92672">=</span>y
    shift
<span style="color:#f92672">}</span>
;;

-npages<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    N_PAGES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>
    shift
    shift
<span style="color:#f92672">}</span>
;;

<span style="color:#75715e"># TODO implement this. By default, results are sorted by creation</span>
<span style="color:#75715e"># date (i.e. for pull requests)</span>
-sort-by<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    SORT_BY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>
    shift
    shift
<span style="color:#f92672">}</span>
;;

*<span style="color:#f92672">)</span> break;
<span style="color:#66d9ef">esac</span>; <span style="color:#66d9ef">done</span>

<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span>$AS_USER<span style="color:#e6db74">&#34;</span> in
    me<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        gh_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat ~/.myrc.yaml | yq -r .github_name<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        gh_email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat ~/.myrc.yaml | yq -r .github_email<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

        : <span style="color:#e6db74">${</span>gh_branch_name:=<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat ~/.myrc.yaml | yq -r .github_default_branch<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">}</span>
        gh_pass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat ~/.myrc.yaml | yq -r .github_pass<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        gh_token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat ~/.myrc.yaml | yq -r .github_token<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        gh_api_token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat ~/.myrc.yaml | yq -r .github_api_token<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        gh_username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat ~/.myrc.yaml | yq -r .github_user<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#f92672">}</span>
    ;;

    *<span style="color:#f92672">)</span>
<span style="color:#66d9ef">esac</span>

: <span style="color:#e6db74">${</span>SORT_BY:=<span style="color:#e6db74">&#34;created&#34;</span><span style="color:#e6db74">}</span>

last_arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>@: -1<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
set -- <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>@:1:<span style="color:#66d9ef">$((</span>$#<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#66d9ef">))</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># shift last arg</span>
url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$last_arg<span style="color:#e6db74">&#34;</span>

<span style="color:#66d9ef">if</span> printf -- <span style="color:#e6db74">&#34;%s\n&#34;</span> <span style="color:#e6db74">&#34;</span>$url<span style="color:#e6db74">&#34;</span> | grep -q -P <span style="color:#e6db74">&#39;//\.api\.github&#39;</span>; <span style="color:#66d9ef">then</span>
    USE_PAGES<span style="color:#f92672">=</span>y
<span style="color:#66d9ef">fi</span>

curl<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    set -vx
    <span style="color:#75715e"># I actually don&#39;t always want -L because I want to get the new url</span>
    <span style="color:#66d9ef">if</span> test <span style="color:#e6db74">&#34;</span>$NO_REDIRECT<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;y&#34;</span>; <span style="color:#66d9ef">then</span>
        /usr/bin/curl -H <span style="color:#e6db74">&#34;Authorization: token </span>$gh_api_token<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">else</span>
        /usr/bin/curl -L -H <span style="color:#e6db74">&#34;Authorization: token </span>$gh_api_token<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> printf -- <span style="color:#e6db74">&#34;%s\n&#34;</span> <span style="color:#e6db74">&#34;</span>$url<span style="color:#e6db74">&#34;</span> | grep -q -P <span style="color:#e6db74">&#39;github\.com/search/&#39;</span>; <span style="color:#66d9ef">then</span>
    USE_PAGES<span style="color:#f92672">=</span>y
    enumerate<span style="color:#f92672">=</span>y
<span style="color:#66d9ef">fi</span>

count_results<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> printf -- <span style="color:#e6db74">&#34;%s\n&#34;</span> <span style="color:#e6db74">&#34;</span>$url<span style="color:#e6db74">&#34;</span> | grep -q -P <span style="color:#e6db74">&#39;/search/&#39;</span>; <span style="color:#66d9ef">then</span>
        jq -r <span style="color:#e6db74">&#39;.items? | length&#39;</span>
    <span style="color:#66d9ef">else</span>
        jq -r <span style="color:#e6db74">&#39;length&#39;</span>
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
<span style="color:#f92672">}</span>

list_results<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> printf -- <span style="color:#e6db74">&#34;%s\n&#34;</span> <span style="color:#e6db74">&#34;</span>$url<span style="color:#e6db74">&#34;</span> | grep -q -P <span style="color:#e6db74">&#39;/search/&#39;</span>; <span style="color:#66d9ef">then</span>
        jq -r <span style="color:#e6db74">&#39;.items[]?&#39;</span>
    <span style="color:#66d9ef">else</span>
        jq -r <span style="color:#e6db74">&#39;.[]&#39;</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> test <span style="color:#e6db74">&#34;</span>$enumerate<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;y&#34;</span>; <span style="color:#66d9ef">then</span>
    tf_results_page<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>ux tf results_page <span style="color:#f92672">||</span> echo /dev/null<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    trap <span style="color:#e6db74">&#34;rm \&#34;</span>$tf_results_page<span style="color:#e6db74">\&#34; 2&gt;/dev/null&#34;</span> <span style="color:#ae81ff">0</span>

    tf_results_combined<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>ux tf results_combined <span style="color:#f92672">||</span> echo /dev/null<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    trap <span style="color:#e6db74">&#34;rm \&#34;</span>$tf_results_combined<span style="color:#e6db74">\&#34; 2&gt;/dev/null&#34;</span> <span style="color:#ae81ff">0</span>

    n_results<span style="color:#f92672">=</span>

    p<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">while</span> :; <span style="color:#66d9ef">do</span>
        curl <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;page=</span>$p<span style="color:#e6db74">&amp;per_page=100&#34;</span> | awk1 &gt; <span style="color:#e6db74">&#34;</span>$tf_results_page<span style="color:#e6db74">&#34;</span>

        n_results<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat <span style="color:#e6db74">&#34;</span>$tf_results_page<span style="color:#e6db74">&#34;</span> | ds -q gh-curl_n_results | count_results<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

        <span style="color:#66d9ef">if</span> test -n <span style="color:#e6db74">&#34;</span>$n_results<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
            cat <span style="color:#e6db74">&#34;</span>$tf_results_page<span style="color:#e6db74">&#34;</span> | ds -q gh-curl_page | list_results &gt;&gt; <span style="color:#e6db74">&#34;</span>$tf_results_combined<span style="color:#e6db74">&#34;</span>
        <span style="color:#66d9ef">fi</span>

        ! test <span style="color:#e6db74">&#34;</span>$n_results<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;100&#34;</span> <span style="color:#f92672">&amp;&amp;</span> break

        test <span style="color:#e6db74">&#34;</span>$N_PAGES<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span>$p<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&amp;&amp;</span> break

        <span style="color:#f92672">((</span>++p<span style="color:#f92672">))</span>
    <span style="color:#66d9ef">done</span>

    cat <span style="color:#e6db74">&#34;</span>$tf_results_combined<span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">else</span>
    <span style="color:#66d9ef">if</span> test <span style="color:#e6db74">&#34;</span>$USE_PAGES<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;y&#34;</span>; <span style="color:#66d9ef">then</span>
        url_suffix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&amp;per_page=100&#34;</span>
    <span style="color:#66d9ef">fi</span>

    curl <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$url$url_suffix<span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">fi</span></code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
