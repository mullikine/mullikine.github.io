<!doctype html>
<html lang="en-us">
  <head>
    <title>Arbitrary interpreters for Babel // Bodacious Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.59.0-DEV" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://mullikine.github.io/css/main.min.86053fdec83c744acefd39104cefd1cfe5020cdde238ce52ce9ca6a898621933.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Arbitrary interpreters for Babel"/>
<meta name="twitter:description" content="The need to specify an arbitrary interpreter arose when I needed
Objective Specify an :interpreter or :filter command to override the execute behaviour.
An interpreter should take a path to the code as its first parameter, where a filter should take the code as stdin.
It should be possible to specify either/or. Filter may be used to clean up the output of the interpreter, for example.
This is what we want show-dot is a script which creates an ascii graph from dot code."/>

    <meta property="og:title" content="Arbitrary interpreters for Babel" />
<meta property="og:description" content="The need to specify an arbitrary interpreter arose when I needed
Objective Specify an :interpreter or :filter command to override the execute behaviour.
An interpreter should take a path to the code as its first parameter, where a filter should take the code as stdin.
It should be possible to specify either/or. Filter may be used to clean up the output of the interpreter, for example.
This is what we want show-dot is a script which creates an ascii graph from dot code." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mullikine.github.io/posts/arbitrary-interpreters-for-babel/" />
<meta property="article:published_time" content="2019-10-20T00:00:00+13:00" />
<meta property="article:modified_time" content="2019-10-20T00:00:00+13:00" /><meta property="og:site_name" content="Bodacious Blog" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://mullikine.github.io"><img class="app-header-avatar" src="http://mullikine.github.io/brainy.png" alt="John Doe" /></a>
      <h1>Bodacious Blog</h1>
      <p>biosemiotics, xenolingustics and emacs</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://linkedin.com/in/shane-mulligan-811b942b/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
        
          <a target="_blank" href="https://gitlab.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-gitlab">
  <title>gitlab</title>
  <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"></path>
</svg></a>
        
          <a target="_blank" href="https://www.facebook.com/shrubgrub"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-facebook">
  <title>facebook</title>
  <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
        <a href="https://mullikine.github.io/cv/">CV</a>
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Arbitrary interpreters for Babel</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Oct 20, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div></div>
    </header>
    <div class="post-content">
      

<p>The need to specify an arbitrary interpreter arose when I needed</p>

<h2 id="objective">Objective</h2>

<p>Specify an <code>:interpreter</code> or <code>:filter</code> command to override the execute behaviour.</p>

<p>An interpreter should take a path to the code as its first parameter, where a filter should take the code as stdin.</p>

<p>It should be possible to specify either/or. Filter may be used to clean up the output of the interpreter, for example.</p>

<h3 id="this-is-what-we-want">This is what we want</h3>

<p><code>show-dot</code> is a script which creates an ascii graph from dot code.</p>

<p>The default behaviour of <code>ob-dot</code> is to create
a pdf file. It only lets you specify arguments
to the <code>dot</code> command, but does not let you
switch the <code>dot</code> command for something else.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-org" data-lang="org"><span style="color:#75715e">#+BEGIN_SRC </span><span style="color:#75715e">dot</span><span style="color:#75715e"> :interpreter show-dot :results verbatim drawer
</span><span style="color:#75715e"></span>  digraph Q {
  node1 -&gt; node2
  }
<span style="color:#75715e">#+END_SRC</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">+-------+
| node1 |
+-------+
  |
  |
  v
+-------+
| node2 |
+-------+</code></pre></div>
<h2 id="existing-features-can-take-us-close">Existing features can take us close</h2>

<p>The problem with this is that you are forced to use <code>sh-mode</code> highlighting and you don&rsquo;t have access to <code>yasnippets</code> that way either.</p>

<p>Another frustration is that the interpreter (e.g. <code>show-dot</code>) must be shebang compatible (i.e. its first argument must be the path of a file containing the code).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-org" data-lang="org"><span style="color:#75715e">#+BEGIN_SRC </span><span style="color:#75715e">sh</span><span style="color:#75715e"> :shebang &#34;#!/usr/bin/env show-dot&#34; :results verbatim drawer
</span><span style="color:#75715e"></span>  digraph Q <span style="color:#f92672">{</span>
  node1 -&gt; node2
  <span style="color:#f92672">}</span>
<span style="color:#75715e">#+END_SRC</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">+-------+
| node1 |
+-------+
  |
  |
  v
+-------+
| node2 |
+-------+</code></pre></div>
<h2 id="solution-extend-babel">Solution: Extend babel</h2>

<h3 id="create-the-org-babel-execute-generic-function">Create the <code>org-babel-execute:generic</code> function</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-emacs" data-lang="emacs">(defun org-babel-execute:generic (body params)
  <span style="color:#e6db74">&#34;:interpreter executes body like &#39;interpreter file&#39;
</span><span style="color:#e6db74">:interpreter filters the source like &#39;cat source | filter&#39;&#34;</span>
  (let ((interpreter (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assoc</span> :interpreter params)))
        (filter (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assoc</span> :filter params)))
        (tmp (org-babel-temp-file <span style="color:#e6db74">&#34;generic-&#34;</span>)))
    (with-temp-file tmp (<span style="color:#a6e22e">insert</span> body))
    (if (not (and (<span style="color:#a6e22e">boundp</span> <span style="color:#e6db74">&#39;interpreter</span>) interpreter))
        (setq interpreter <span style="color:#e6db74">&#34;cat&#34;</span>))
    (if (and (<span style="color:#a6e22e">boundp</span> <span style="color:#e6db74">&#39;filter</span>) filter)
        (setq filter (<span style="color:#a6e22e">concat</span> <span style="color:#e6db74">&#34;| &#34;</span> filter)))
    (shell-command-to-string (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;%s %s %s&#34;</span> interpreter tmp filter))))</code></pre></div>
<h3 id="extend-the-org-babel-execute-src-block-function">Extend the <code>org-babel-execute-src-block</code> function</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-emacs" data-lang="emacs"><span style="color:#75715e">;; New code:</span>
<span style="color:#75715e">;; --------</span>
<span style="color:#75715e">;; (interpreter (cdr (assq :interpreter params)))</span>
<span style="color:#75715e">;; (filter (cdr (assq :filter params)))</span>
<span style="color:#75715e">;; (if (or interpreter filter)</span>
<span style="color:#75715e">;;     (setq cmd &#39;org-babel-execute:generic))</span>

(defun org-babel-execute-src-block (<span style="color:#66d9ef">&amp;optional</span> arg info params)
  <span style="color:#e6db74">&#34;Execute the current source code block.
</span><span style="color:#e6db74">Insert the results of execution into the buffer.  Source code
</span><span style="color:#e6db74">execution and the collection and formatting of results can be
</span><span style="color:#e6db74">controlled through a variety of header arguments.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">With prefix argument ARG, force re-execution even if an existing
</span><span style="color:#e6db74">result cached in the buffer would otherwise have been returned.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Optionally supply a value for INFO in the form returned by
</span><span style="color:#e6db74"></span><span style="color:#e6db74">`org-babel-get-src-block-info&#39;</span><span style="color:#e6db74">.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Optionally supply a value for PARAMS which will be merged with
</span><span style="color:#e6db74">the header arguments specified at the front of the source code
</span><span style="color:#e6db74">block.&#34;</span>
  (interactive)
  (let* ((org-babel-current-src-block-location
          (or org-babel-current-src-block-location
              (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">5</span> info)
              (org-babel-where-is-src-block-head)))
         (info (if info (copy-tree info) (org-babel-get-src-block-info))))
    <span style="color:#75715e">;; Merge PARAMS with INFO before considering source block</span>
    <span style="color:#75715e">;; evaluation since both could disagree.</span>
    (cl-callf org-babel-merge-params (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">2</span> info) params)
    (when (org-babel-check-evaluate info)
      (cl-callf org-babel-process-params (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">2</span> info))
      (let* ((params (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">2</span> info))
             (interpreter (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :interpreter params)))
             (filter (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :filter params)))
             (cache (let ((c (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :cache params))))
                      (and (not arg) c (string= <span style="color:#e6db74">&#34;yes&#34;</span> c))))
             (new-hash (and cache (org-babel-sha1-hash info)))
             (old-hash (and cache (org-babel-current-result-hash)))
             (current-cache (and new-hash (<span style="color:#a6e22e">equal</span> new-hash old-hash))))
        (cond
         (current-cache
          (save-excursion               <span style="color:#75715e">;Return cached result.</span>
            (<span style="color:#a6e22e">goto-char</span> (org-babel-where-is-src-block-result <span style="color:#66d9ef">nil</span> info))
            (<span style="color:#a6e22e">forward-line</span>)
            (<span style="color:#a6e22e">skip-chars-forward</span> <span style="color:#e6db74">&#34; \t&#34;</span>)
            (let ((result (org-babel-read-result)))
              (<span style="color:#a6e22e">message</span> (replace-regexp-in-string <span style="color:#e6db74">&#34;%&#34;</span> <span style="color:#e6db74">&#34;%%&#34;</span> (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;%S&#34;</span> result)))
              result)))
         ((org-babel-confirm-evaluate info)
          (let* ((lang (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">0</span> info))
                 (result-params (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :result-params params)))
                 <span style="color:#75715e">;; Expand noweb references in BODY and remove any</span>
                 <span style="color:#75715e">;; coderef.</span>
                 (body
                  (let ((coderef (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">6</span> info))
                        (expand
                         (if (org-babel-noweb-p params :eval)
                             (org-babel-expand-noweb-references info)
                           (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">1</span> info))))
                    (if (not coderef) expand
                      (replace-regexp-in-string
                       (org-src-coderef-regexp coderef) <span style="color:#e6db74">&#34;&#34;</span> expand <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">nil</span> <span style="color:#ae81ff">1</span>))))
                 (dir (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :dir params)))
                 (default-directory
                   (or (and dir (<span style="color:#a6e22e">file-name-as-directory</span> (<span style="color:#a6e22e">expand-file-name</span> dir)))
                       default-directory))
                 (cmd (<span style="color:#a6e22e">intern</span> (<span style="color:#a6e22e">concat</span> <span style="color:#e6db74">&#34;org-babel-execute:&#34;</span> lang)))
                 result)
            (if (or interpreter filter)
                (setq cmd <span style="color:#e6db74">&#39;org-babel-execute:generic</span>))
            (unless (<span style="color:#a6e22e">fboundp</span> cmd)
              (<span style="color:#a6e22e">error</span> <span style="color:#e6db74">&#34;No org-babel-execute function for %s!&#34;</span> lang))
            (<span style="color:#a6e22e">message</span> <span style="color:#e6db74">&#34;executing %s code block%s...&#34;</span>
                     (<span style="color:#a6e22e">capitalize</span> lang)
                     (let ((name (<span style="color:#a6e22e">nth</span> <span style="color:#ae81ff">4</span> info)))
                       (if name (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34; (%s)&#34;</span> name) <span style="color:#e6db74">&#34;&#34;</span>)))
            (if (<span style="color:#a6e22e">member</span> <span style="color:#e6db74">&#34;none&#34;</span> result-params)
                (progn (<span style="color:#a6e22e">funcall</span> cmd body params)
                       (<span style="color:#a6e22e">message</span> <span style="color:#e6db74">&#34;result silenced&#34;</span>))
              (setq result
                    (let ((r (<span style="color:#a6e22e">funcall</span> cmd body params)))
                      (if (and (<span style="color:#a6e22e">eq</span> (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :result-type params)) <span style="color:#e6db74">&#39;value</span>)
                               (or (<span style="color:#a6e22e">member</span> <span style="color:#e6db74">&#34;vector&#34;</span> result-params)
                                   (<span style="color:#a6e22e">member</span> <span style="color:#e6db74">&#34;table&#34;</span> result-params))
                               (not (<span style="color:#a6e22e">listp</span> r)))
                          (<span style="color:#a6e22e">list</span> (<span style="color:#a6e22e">list</span> r))
                        r)))
              (let ((file (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :file params))))
                <span style="color:#75715e">;; If non-empty result and :file then write to :file.</span>
                (when file
                  (when result
                    (with-temp-file file
                      (<span style="color:#a6e22e">insert</span> (org-babel-format-result
                               result (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :sep params))))))
                  (setq result file))
                <span style="color:#75715e">;; Possibly perform post process provided its</span>
                <span style="color:#75715e">;; appropriate.  Dynamically bind &#34;*this*&#34; to the</span>
                <span style="color:#75715e">;; actual results of the block.</span>
                (let ((post (<span style="color:#a6e22e">cdr</span> (<span style="color:#a6e22e">assq</span> :post params))))
                  (when post
                    (let ((*this* (if (not file) result
                                    (org-babel-result-to-file
                                     file
                                     (let ((desc (<span style="color:#a6e22e">assq</span> :file-desc params)))
                                       (and desc (or (<span style="color:#a6e22e">cdr</span> desc) result)))))))
                      (setq result (org-babel-ref-resolve post))
                      (when file
                        (setq result-params (remove <span style="color:#e6db74">&#34;file&#34;</span> result-params))))))
                (org-babel-insert-result
                 result result-params info new-hash lang)))
            (<span style="color:#a6e22e">run-hooks</span> <span style="color:#e6db74">&#39;org-babel-after-execute-hook</span>)
            result)))))))</code></pre></div>
<h2 id="results">Results!</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-org" data-lang="org"><span style="color:#75715e">#+BEGIN_SRC </span><span style="color:#75715e">dot</span><span style="color:#75715e"> :interpreter &#34;sed /delete/d&#34; :filter &#34;show-dot | sed s/node2/__2__/&#34; :results verbatim drawer
</span><span style="color:#75715e"></span>  digraph Q {
  node1 -&gt; node2
  node2 -&gt; node3
  node3 -&gt; node4

  node1 -&gt; deletethis
  }
<span style="color:#75715e">#+END_SRC</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">+-------+
| node1 |
+-------+
  |
  |
  v
+-------+
| __2__ |
+-------+
  |
  |
  v
+-------+
| node3 |
+-------+
  |
  |
  v
+-------+
| node4 |
+-------+</code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
