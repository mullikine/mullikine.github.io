<!doctype html>
<html lang="en-us">
  <head>
    <title>Templating mermaid diagrams and other files // Bodacious Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.82.0-DEV" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Shane Mulligan" />
    <meta name="description" content="" />

    <script type="text/javascript" src="//script.crazyegg.com/pages/scripts/0107/2398.js" async="async"></script>

    <link rel="stylesheet" href="https://mullikine.github.io/css/main.min.74b7ce8969da573c135a6e8e56284812583cc4a84e83b075f17ca5a7f84a7d40.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Templating mermaid diagrams and other files"/>
<meta name="twitter:description" content="Related mustache templating processor // Bodacious Blog Code for mustache-transform http://github.com/mullikine/mustache-transform  Summary I would like to place lengthy strings into mermaid diagram nodes, but I don&rsquo;t want to worry about escaping characters or formatting the text.
The problem I&rsquo;m trying to solve is that a simple string substitution is not enough for many formats, including mermaid files.
There may be some additional transformation that needs to be applied to the string before it goes into the file."/>

    <meta property="og:title" content="Templating mermaid diagrams and other files" />
<meta property="og:description" content="Related mustache templating processor // Bodacious Blog Code for mustache-transform http://github.com/mullikine/mustache-transform  Summary I would like to place lengthy strings into mermaid diagram nodes, but I don&rsquo;t want to worry about escaping characters or formatting the text.
The problem I&rsquo;m trying to solve is that a simple string substitution is not enough for many formats, including mermaid files.
There may be some additional transformation that needs to be applied to the string before it goes into the file." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mullikine.github.io/posts/templating-mermaid-diagrams/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-11T00:00:00&#43;13:00" />
<meta property="article:modified_time" content="2021-03-11T00:00:00&#43;13:00" /><meta property="og:site_name" content="Bodacious Blog" />



  </head>
  <body>

    <header class="app-header">

<a href="https://mullikine.github.io"><img class="app-header-avatar" src="http://mullikine.github.io/fievel.png" alt="Shane Mulligan" /></a>
      <h1>Bodacious Blog</h1>
      
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://linkedin.com/in/shane-mulligan-811b942b/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
        
          <a target="_blank" href="https://gitlab.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-gitlab">
  <title>gitlab</title>
  <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/mullikine"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
        <a href="https://mullikine.github.io/cv/">CV</a>
      </div>
<div class="highlights">
<a href="https://mullikine.github.io/posts/practical-macros-in-racket-and-how-to-work-with-them/">Practical macros in Racket</a>
<br />
<a href="https://mullikine.github.io/posts/generating-hyperlinks-for-glossaries-and-other-parsers-in-emacs/">Hyperlink generation in emacs</a>
<br />
<a href="https://mullikine.github.io/posts/github-search-with-bigquery/">Searching GitHub with BigQuery</a>

<br />
<a href="https://mullikine.github.io/posts/review-of-the-case-for-learned-index-structures/">Case for Learned Index Structures</a>
<br />
<a href="https://mullikine.github.io/posts/arbitrary-interpreters-for-babel/">Arbitrary interpreters for Babel</a>
<br />
<a href="https://mullikine.github.io/glossary.html">Glossary A-Z (298 topics)</a> <a href="https://github.com/mullikine/glossaries-gh">code</a>
<br />
<a href="https://mullikine.github.io/posts/dwarf-fortress-macros-with-emacs-and-tmux/">Automating Dwarf Fortress</a>
<br />
<a href="https://mullikine.github.io/posts/review-of-the-illustrated-transformer/">The Illustrated Transformer</a>
<br />
<a href="https://mullikine.github.io/codelingo-vs-linters/summary/">CodeLingo vs Linters</a>
<br />
<a class="big" href="https://infogetics.github.io/">Infogetics on GitHub</a>
<br />
<a class="big" href="https://github.com/semiosis">Semiosis on GitHub</a>
<br />
<a class="big" href="https://takaheai.github.io/">TakaheAI on GitHub</a>
<br />
<div class="taglist">

  <a class="tag" href="https://mullikine.github.io/tags/gpt/">GPT (Generative Pre-trained Transformer)</a>
<a class="tag" href="https://mullikine.github.io/tags/biosemiotics/">biosemiotics</a>
<a class="tag" href="https://mullikine.github.io/tags/xenolinguistics/">xenolinguistics</a>
<a class="tag big" href="https://mullikine.github.io/tags/emacs/">emacs</a>
<a class="tag" href="https://mullikine.github.io/tags/elisp/">elisp</a>
<a class="tag" href="https://mullikine.github.io/tags/racket/">racket</a>
<a class="tag" href="https://mullikine.github.io/tags/haskell/">haskell</a>
<a class="tag" href="https://mullikine.github.io/tags/nlp/">NLP</a>
<a class="tag" href="https://mullikine.github.io/tags/docker/">docker</a>
<a class="tag" href="https://mullikine.github.io/tags/feature-engineering/">feature-engineering</a>
<a class="tag big" href="https://mullikine.github.io/tags/ir/">IR</a>
<a class="tag" href="https://mullikine.github.io/tags/games/">games</a>
<a class="tag" href="https://mullikine.github.io/tags/data/">data</a>
<a class="tag" href="https://mullikine.github.io/tags/info/">info theory</a>
<a class="tag" href="https://mullikine.github.io/tags/probability/">probability</a>
<a class="tag" href="https://mullikine.github.io/tags/problog/">problog</a>
<a class="tag big" href="https://mullikine.github.io/tags/shell/">shell</a>

<a class="tag" href="https://mullikine.github.io/tags/tooling/">tooling</a>
<a class="tag" href="https://mullikine.github.io/tags/iac/">IaC</a>
<a class="tag big" href="https://mullikine.github.io/tags/facebook/">Facebook</a>
<a class="tag" href="https://mullikine.github.io/tags/wfh/">WFH</a>


<a class="tag" href="https://mullikine.github.io/tags/babel/">babel</a>

<a class="tag" href="https://mullikine.github.io/tags/gcp/">GCP</a>
<a class="tag big" href="https://mullikine.github.io/tags/github/">GitHub</a>
<a class="tag" href="https://mullikine.github.io/tags/parsers/">parsers</a>
<a class="tag" href="https://mullikine.github.io/tags/rust/">rust</a>
<a class="tag" href="https://mullikine.github.io/tags/cpp/">c++</a>
<a class="tag" href="https://mullikine.github.io/tags/review/">review</a>
<a class="tag" href="https://mullikine.github.io/tags/kaggle/">kaggle</a>
<a class="tag" href="https://mullikine.github.io/tags/dl/">deep learning</a>
<a class="tag" href="https://mullikine.github.io/tags/dsl/">DSL</a>
<a class="tag" href="https://mullikine.github.io/tags/music/">music</a>
<a class="tag" href="https://mullikine.github.io/tags/df/">dwarf fortress</a>
<a class="tag" href="https://mullikine.github.io/tags/spacy/">spacy</a>
<a class="tag" href="https://mullikine.github.io/tags/latex/">latex</a>
<a class="tag" href="https://mullikine.github.io/tags/nix/">Nix</a>
<a class="tag" href="https://mullikine.github.io/tags/diagrams/">diagrams</a>
<a class="tag big" href="https://mullikine.github.io/tags/faith/">faith</a>
<a class="tag" href="https://mullikine.github.io/tags/python/">python</a>
<a class="tag" href="https://mullikine.github.io/tags/neural-engineering/">neural-engineering</a>
<a class="tag" href="https://mullikine.github.io/tags/golang/">golang</a>
<a class="tag" href="https://mullikine.github.io/tags/codelingo/">codelingo</a>
<a class="tag" href="https://mullikine.github.io/tags/aws/">AWS</a>
<a class="tag" href="https://mullikine.github.io/tags/perl/">perl</a>
<a class="tag big" href="https://mullikine.github.io/tags/vim/">vim</a>
<a class="tag" href="https://mullikine.github.io/tags/telco/">telco</a>
<a class="tag" href="https://mullikine.github.io/tags/automation/">automation</a>
<a class="tag" href="https://mullikine.github.io/tags/optimisation/">optimisation</a>
<a class="tag" href="https://mullikine.github.io/tags/release/">release</a>
<a class="tag" href="https://mullikine.github.io/tags/dotnet/">.NET</a>
<a class="tag" href="https://mullikine.github.io/tags/csharp/">csharp</a>
<a class="tag big" href="https://mullikine.github.io/tags/uber/">Uber</a>
<a class="tag" href="https://mullikine.github.io/tags/math/">math</a>
<a class="tag" href="https://mullikine.github.io/tags/microsoft/">Microsoft</a>
<a class="tag big" href="https://mullikine.github.io/tags/neuralink/">Neuralink</a>
<a class="tag big" href="https://mullikine.github.io/tags/openai/">OpenAI</a>
<a class="tag" href="https://mullikine.github.io/tags/terminals/">terminals</a>
<a class="tag" href="https://mullikine.github.io/tags/transformer/">transformer</a>
<a class="tag big" href="https://mullikine.github.io/tags/codegen/">code-gen</a>
<a class="tag" href="https://mullikine.github.io/tags/rosie/">rosie</a>
<a class="tag" href="https://mullikine.github.io/tags/terraform/">Terraform</a>
<a class="tag" href="https://mullikine.github.io/tags/elasticsearch/">ELK</a>
<a class="tag" href="https://mullikine.github.io/tags/semmle/">Semmle</a>
<a class="tag" href="https://mullikine.github.io/tags/expect/">tcl/expect</a>
<a class="tag" href="https://mullikine.github.io/tags/solr/">solr</a>
</div>
</div>



</div>
<div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <div class="post-footer phone">
      <p>
        <a href="https://mullikine.github.io/">Latest articles</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/tags/">Site Map</a>
      </p>
    </div>
    <header class="post-header">
      <h1 class ="post-title">Templating mermaid diagrams and other files</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Mar 11, 2021
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          7 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://mullikine.github.io/tags/mermaid/">mermaid</a><a class="tag" href="http://mullikine.github.io/tags/diagrams/">diagrams</a><a class="tag" href="http://mullikine.github.io/tags/dsl/">dsl</a><a class="tag" href="http://mullikine.github.io/tags/clojure/">clojure</a></div></div>
    </header>
    

<link rel="stylesheet" type="text/css" href="https://mullikine.github.io/css/magit.css"/>

<script src="https://mullikine.github.io/js/mathjax-config.js"></script>
 
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>


    <div class="post-content">
      <dl>
<dt>Related</dt>
<dd><a href="https://mullikine.github.io/posts/mustache-templating-processor/">mustache templating processor // Bodacious Blog</a></dd>
<dt>Code for <code>mustache-transform</code></dt>
<dd><a href="http://github.com/mullikine/mustache-transform">http://github.com/mullikine/mustache-transform</a></dd>
</dl>
<h2 id="summary">Summary</h2>
<p>I would like to place lengthy strings into
mermaid diagram nodes, but I don&rsquo;t want to
worry about escaping characters or formatting
the text.</p>
<p>The <span class="underline">problem</span> I&rsquo;m trying to solve is that a simple string substitution is not enough for many formats, including <code>mermaid</code> files.</p>
<p>There may be some additional transformation that needs to be applied to the string before it goes into the file.</p>
<p>I design a simple templating pipeline for
automatically escaping text and inserting it
into mermaid diagrams and also for working
with mermaid graphs within emacs' babel.</p>
<p>I have made it trivial for me to develop large
flowcharts with large amounts of text and
special characters.</p>
<p>I also try to make the process generic enough
to be adaptable and useful for templating
other file formats.</p>
<p><code>YAML</code> turns out to be an excellent format for
in storing configuration data and program
input due to its heredoc syntax.</p>
<h2 id="code">Code</h2>
<h3 id="template"><code>template</code></h3>
<p>This script is a makeshift template preprocessor, which I use to do the substitution initially.</p>
<p>I did it this way first just to get an idea of how I was going to approach the task. But the final code will use <code>mustache</code>, a much more robust templating tool.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>export TTY

stdin_exists<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    ! <span style="color:#f92672">[</span> -t <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> stdin_exists; <span style="color:#66d9ef">then</span>
    fp<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>tf txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">else</span>
    echo <span style="color:#e6db74">&#34;requires stdin&#34;</span> 1&gt;&amp;<span style="color:#ae81ff">2</span>
    exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> $# -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">do</span> opt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span>$opt<span style="color:#e6db74">&#34;</span> in
    -<span style="color:#f92672">[</span>a-z0-9<span style="color:#f92672">]</span>*<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        varname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>p <span style="color:#e6db74">&#34;</span>$opt<span style="color:#e6db74">&#34;</span> | mcut -d- -f2<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        contents<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>
        shift
        shift
        varname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>p <span style="color:#e6db74">&#34;</span>$varname<span style="color:#e6db74">&#34;</span> | sed <span style="color:#e6db74">&#39;s/\s\+//g&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>                                        <span style="color:#75715e"># no spaces</span>
        varname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>p <span style="color:#e6db74">&#34;</span>$varname<span style="color:#e6db74">&#34;</span> | sed -e <span style="color:#e6db74">&#39;s/\(.*\)/\L\1/&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>                                <span style="color:#75715e"># lowercase</span>
        varname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>p <span style="color:#e6db74">&#34;</span>$varname<span style="color:#e6db74">&#34;</span> | fuzzify-regex -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>                                       <span style="color:#75715e"># let params match fields with spaces</span>

        cat <span style="color:#e6db74">&#34;</span>$fp<span style="color:#e6db74">&#34;</span> | ptw replace-substring -i -m <span style="color:#e6db74">&#34;&lt;</span>$varname<span style="color:#e6db74">&gt;&#34;</span> -r <span style="color:#e6db74">&#34;</span>$contents<span style="color:#e6db74">&#34;</span> | sponge <span style="color:#e6db74">&#34;</span>$fp<span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># perform variable replacement</span>
        cat <span style="color:#e6db74">&#34;</span>$fp<span style="color:#e6db74">&#34;</span> | sed <span style="color:#e6db74">&#39;s/\(\b1 [a-zA-Z]\+\)s\b/\1/g&#39;</span> | sponge <span style="color:#e6db74">&#34;</span>$fp<span style="color:#e6db74">&#34;</span>                      <span style="color:#75715e"># fix singular plural</span>
        cat <span style="color:#e6db74">&#34;</span>$fp<span style="color:#e6db74">&#34;</span> | sed <span style="color:#e6db74">&#39;s/&#34;&#34;/&#34;/g&#39;</span> | sponge <span style="color:#e6db74">&#34;</span>$fp<span style="color:#e6db74">&#34;</span>                                          <span style="color:#75715e"># fix CSV double quote</span>
    <span style="color:#f92672">}</span>
    ;;

    *<span style="color:#f92672">)</span> break;
<span style="color:#66d9ef">esac</span>; <span style="color:#66d9ef">done</span>

cat <span style="color:#e6db74">&#34;</span>$fp<span style="color:#e6db74">&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="using-makeshift-template-preprocessor">Using makeshift template preprocessor</h2>
<h3 id="demonstration">Demonstration</h3>
<p>This mermaid diagram template needs <code>&lt;parsemetadata&gt;</code> to be replaced by a string which is syntactically correct.</p>
<p>The string must be a single lined double quoted string and where newlines are to appear, the html tag <code>&lt;br /&gt;</code> must appear.</p>
<p>I don&rsquo;t want to remember those rules. I just want to automate that templating process.</p>
<p><a id="code-snippet--label"></a>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Parse metadata.csv and for each row, extract
the title, abstract, date published etc.
(contained directly in the csv) and bodytext of
the article (from the article json file)</code></pre></td></tr></table>
</div>
</div></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sed -z <span style="color:#e6db74">&#39;s=\n=&lt;br /&gt;=g&#39;</span></code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Parse metadata.csv and <span style="color:#66d9ef">for</span> each row, extract&lt;br /&gt;the title, abstract, date published etc.&lt;br /&gt;<span style="color:#f92672">(</span>contained directly in the csv<span style="color:#f92672">)</span> and bodytext of&lt;br /&gt;the article <span style="color:#f92672">(</span>from the article json file<span style="color:#f92672">)</span>
</code></pre></div><p><a id="code-snippet--mermaidgraph"></a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">graph TD
    A[&lt;parsemetadata&gt;] --&gt; B{Is it?};
    B -- Yes --&gt; C[OK];
    C --&gt; D[Rethink];
    D --&gt; B;
    B -- No ----&gt; E[End];
</code></pre></div><p><code>aqf-nice</code> just double quotes the string.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">template -parsemetadata <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>aqf-nice <span style="color:#e6db74">&#34;Parse metadata.csv and for each row, extract&lt;br /&gt;the title, abstract, date published etc.&lt;br /&gt;(contained directly in the csv) and bodytext of&lt;br /&gt;the article (from the article json file)&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span></code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">graph TD
    A<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Parse metadata.csv and for each row, extract&lt;br /&gt;the title, abstract, date published etc.&lt;br /&gt;(contained directly in the csv) and bodytext of&lt;br /&gt;the article (from the article json file)&#34;</span><span style="color:#f92672">]</span> --&gt; B<span style="color:#f92672">{</span>Is it?<span style="color:#f92672">}</span>;
    B -- Yes --&gt; C<span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>;
    C --&gt; D<span style="color:#f92672">[</span>Rethink<span style="color:#f92672">]</span>;
    D --&gt; B;
    B -- No ----&gt; E<span style="color:#f92672">[</span>End<span style="color:#f92672">]</span>;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">graph TD
  A[&#34;Parse metadata.csv and for each row, extract&lt;br /&gt;the title, abstract, date published etc.&lt;br /&gt;(contained directly in the csv) and bodytext of&lt;br /&gt;the article (from the article json file)&#34;] --&gt; B{Is it?};
  B -- Yes --&gt; C[OK];
  C --&gt; D[Rethink];
  D --&gt; B;
  B -- No ----&gt; E[End];
</code></pre></div><figure>
    <img src="https://mullikine.github.io/ox-hugo/mermaid-template.png"/> 
</figure>

<h2 id="using-mustache">Using <code>mustache</code></h2>
<p>Mustache needs a data file.</p>
<p><a id="code-snippet--mermaiddata"></a>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">parsemetadata</span>: |-<span style="color:#e6db74">
</span><span style="color:#e6db74">  Parse metadata.csv and for each row, extract
</span><span style="color:#e6db74">  the title, abstract, date published etc.
</span><span style="color:#e6db74">  (contained directly in the csv) and bodytext of
</span><span style="color:#e6db74">  the article (from the article json file)</span>  
<span style="color:#f92672">applytextprocessing</span>: |-<span style="color:#e6db74">
</span><span style="color:#e6db74">  Apply text processing (see Text Processing
</span><span style="color:#e6db74">  for details) and split text block into
</span><span style="color:#e6db74">  sentences using nltk tokenizer</span>  </code></pre></td></tr></table>
</div>
</div></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">mermaiddata-raw.yaml</span>
</code></pre></div><p><code>{{{</code> in mustache means that the variable text will not be transformed into html entities.</p>
<p>If I use <code>{{</code> then text such as <code>&lt;br /</code> will come out as entities instead.</p>
<p><a id="code-snippet--mermaidtemplate"></a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">graph TD
    A[{{{parsemetadata}}}] --&gt; B{Is it?};
    B[{{{applytextprocessing}}}] -- Yes --&gt; C[OK];
    C --&gt; D[Rethink];
    D --&gt; B;
    B -- No ----&gt; E[End];
</code></pre></div><p>&lt;irparse.mermaid&gt;</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mustache mermaiddata.yaml irparse.mermaid</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">graph TD
  A[Parse metadata.csv and for each row, extract
the title, abstract, date published etc.
(contained directly in the csv) and bodytext of
the article (from the article json file)] --&gt; B{Is it?};
  B -- Yes --&gt; C[OK];
  C --&gt; D[Rethink];
  D --&gt; B;
  B -- No ----&gt; E[End];
</code></pre></div><p>But how can I then include the <code>sed</code> command in the pipeline?</p>
<p>I need something new. I need to define a new format. This should go alongside the data file, but specify the transformations.</p>
<p>List all the keys, for each key pipe through associated filter.
Reconstruct the yaml.</p>
<p><a id="code-snippet--mermaidtransforms"></a>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">parsemetadata</span>: |-<span style="color:#e6db74">
</span><span style="color:#e6db74">  </span>  <span style="color:#ae81ff">sed -z &#39;s=\n=&lt;br /&gt;=g&#39; | q -f</span>
<span style="color:#f92672">applytextprocessing</span>: |-<span style="color:#e6db74">
</span><span style="color:#e6db74">  </span>  <span style="color:#ae81ff">sed -z &#39;s=\n=&lt;br /&gt;=g&#39; | q -f</span></code></pre></td></tr></table>
</div>
</div></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">transformations.yaml</span>
</code></pre></div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat mermaiddata-raw.yaml | yq -r <span style="color:#e6db74">&#34;. | keys[]&#34;</span></code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">applytextprocessing
parsemetadata
</code></pre></div><h2 id="mustache-transform"><code>mustache-transform</code></h2>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>export TTY

<span style="color:#f92672">(</span> hs <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>basename <span style="color:#e6db74">&#34;</span>$0<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#e6db74">&#34;&lt;==&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>ps -o comm<span style="color:#f92672">=</span> $PPID<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> 0&lt;/dev/null <span style="color:#f92672">)</span> &amp;&gt;/dev/null

data<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
test -f <span style="color:#e6db74">&#34;</span>$data<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> exit <span style="color:#ae81ff">1</span>
trans<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>
test -f <span style="color:#e6db74">&#34;</span>$trans<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> exit <span style="color:#ae81ff">1</span>

<span style="color:#75715e"># lein uberjar</span>
java -jar $MYGIT/mullikine/mustache-transform/target/uberjar/mustache-transform-0.1.0-SNAPSHOT-standalone.jar <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span> | yq . | pavs</code></pre></td></tr></table>
</div>
</div>
<p><code>mullikine/mustache-transform</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#66d9ef">ns </span>mustache-transform.core
  (<span style="color:#e6db74">:gen-class</span>)
  (<span style="color:#e6db74">:require</span> [clj-yaml.core <span style="color:#e6db74">:as</span> yaml]
            [clojure.pprint <span style="color:#e6db74">:as</span> pp]
            [clojure.set <span style="color:#e6db74">:as</span> set]))

(<span style="color:#a6e22e">use</span> <span style="color:#f92672">&#39;</span>[clojure.java.shell <span style="color:#e6db74">:only</span> [sh]])

(<span style="color:#66d9ef">defn </span>transform-map [m fm]
  (into {}
        (<span style="color:#a6e22e">map</span>
         (<span style="color:#66d9ef">fn </span>[[k v]]
           [k (<span style="color:#e6db74">:out</span> (<span style="color:#a6e22e">sh</span> <span style="color:#e6db74">&#34;sh&#34;</span> <span style="color:#e6db74">&#34;-c&#34;</span> v <span style="color:#e6db74">:in</span> (<span style="color:#a6e22e">k</span> m)))])
         fm)))

(<span style="color:#66d9ef">defn </span>-main
  <span style="color:#e6db74">&#34;I don&#39;t do a whole lot ... yet.&#34;</span>
  ([data-fp transform-fp <span style="color:#f92672">&amp;</span> args]
   (<span style="color:#66d9ef">let </span>[data (<span style="color:#a6e22e">yaml/parse-string</span> (slurp data-fp))
         transform (<span style="color:#a6e22e">yaml/parse-string</span> (slurp transform-fp))]

     <span style="color:#75715e">;; running from uberjar appears to need println, not print</span>
     (println (<span style="color:#a6e22e">yaml/generate-string</span> newdata  <span style="color:#e6db74">:dumper-options</span> {<span style="color:#e6db74">:flow-style</span> <span style="color:#e6db74">:block</span>}))
     (<span style="color:#a6e22e">shutdown-agents</span>))))</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mustache-transform mermaiddata-raw.yaml transformations.yaml</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">parsemetadata: Parse metadata.csv and <span style="color:#66d9ef">for</span> each row, extract&lt;br /&gt;the title, abstract, date published etc.&lt;br /&gt;<span style="color:#f92672">(</span>contained directly in the csv<span style="color:#f92672">)</span> and bodytext of&lt;br /&gt;the article <span style="color:#f92672">(</span>from the article json file<span style="color:#f92672">)</span>
applytextprocessing: Apply text processing <span style="color:#f92672">(</span>see Text Processing&lt;br /&gt;for details<span style="color:#f92672">)</span> and split text block into&lt;br /&gt;sentences using nltk tokenizer

</code></pre></div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mustache mermaiddata-raw.yaml irparse.mermaid</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">graph TD
    A<span style="color:#f92672">[</span>Parse metadata.csv and <span style="color:#66d9ef">for</span> each row, extract
the title, abstract, date published etc.
<span style="color:#f92672">(</span>contained directly in the csv<span style="color:#f92672">)</span> and bodytext of
the article <span style="color:#f92672">(</span>from the article json file<span style="color:#f92672">)]</span> --&gt; B<span style="color:#f92672">{</span>Is it?<span style="color:#f92672">}</span>;
    B<span style="color:#f92672">[</span>Apply text processing <span style="color:#f92672">(</span>see Text Processing
<span style="color:#66d9ef">for</span> details<span style="color:#f92672">)</span> and split text block into
sentences using nltk tokenizer<span style="color:#f92672">]</span> -- Yes --&gt; C<span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>;
    C --&gt; D<span style="color:#f92672">[</span>Rethink<span style="color:#f92672">]</span>;
    D --&gt; B;
    B -- No ----&gt; E<span style="color:#f92672">[</span>End<span style="color:#f92672">]</span>;
</code></pre></div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mustache <span style="color:#f92672">=(</span>mustache-transform mermaiddata-raw.yaml transformations.yaml<span style="color:#f92672">)</span> irparse.mermaid</code></pre></td></tr></table>
</div>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">graph TD
    A<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Parse metadata.csv and for each row, extract&lt;br /&gt;the title, abstract, date published etc.&lt;br /&gt;(contained directly in the csv) and bodytext of&lt;br /&gt;the article (from the article json file)&#34;</span><span style="color:#f92672">]</span> --&gt; B<span style="color:#f92672">{</span>Is it?<span style="color:#f92672">}</span>;
    B<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Apply text processing (see Text Processing&lt;br /&gt;for details) and split text block into&lt;br /&gt;sentences using nltk tokenizer&#34;</span><span style="color:#f92672">]</span> -- Yes --&gt; C<span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>;
    C --&gt; D<span style="color:#f92672">[</span>Rethink<span style="color:#f92672">]</span>;
    D --&gt; B;
    B -- No ----&gt; E<span style="color:#f92672">[</span>End<span style="color:#f92672">]</span>;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">graph TD
    A[&#34;Parse metadata.csv and for each row, extract&lt;br /&gt;the title, abstract, date published etc.&lt;br /&gt;(contained directly in the csv) and bodytext of&lt;br /&gt;the article (from the article json file)&#34;] --&gt; B{Is it?};
    B[&#34;Apply text processing (see Text Processing&lt;br /&gt;for details) and split text block into&lt;br /&gt;sentences using nltk tokenizer&#34;] -- Yes --&gt; C[OK];
    C --&gt; D[Rethink];
    D --&gt; B;
    B -- No ----&gt; E[End];
</code></pre></div><figure>
    <img src="https://mullikine.github.io/ox-hugo/mermaid-template-new.png"/> 
</figure>


    </div>
    <div class="post-footer">
        <p>
        <a href="https://mullikine.github.io/">Latest articles</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/about/">About this weblog</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://asciinema.org/~mullikine">Asciinema recordings</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/posts/blogs-and-vlogs/">Blogs and Vlogs</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/cv/">CV</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://github.com/semiosis/pen.el">Pen</a>
        &nbsp;
        ⚔
        &nbsp;
        <a href="https://mullikine.github.io/tags/">Site Map</a>
        </p>
    </div>
  </article>

    </main>
  </body>
</html>
